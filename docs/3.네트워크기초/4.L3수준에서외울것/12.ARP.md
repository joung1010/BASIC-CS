## ARP(Address Resolution Protocol)

### 네트워크에서의 주소 체계

**ARP에서 Address라고 하면 IP 주소, MAC 주소가 있습니다. 그러면 네트워크에 연결된 Host에게 주소라고 말할 수 있는 것은 먼저 인터넷에 연결될 때 이 거대한 인터넷이라는 논리 네트워크에서 호스트를 유일하게 식별할 수 있는 유니크한 식별값인 IP 주소와 NIC에 부여된 MAC 주소가 있습니다.**

### 주소의 이중 구조와 필요성

**근데 보통은 이 IP 주소와 MAC 주소가 한 쌍을 이룹니다. 근데 L3 통신을 하는데 있어서 L2의 MAC 주소까지 알아야 될까요? 특정 필요한 구간에서는 알아야 됩니다.**

```
주소 체계의 계층적 사용:

L3 (Network Layer) - IP 주소:
┌─────────────────────────────────────────┐
│ • 글로벌 유일성 (전 세계 인터넷)        │
│ • 논리적 주소 (설정 가능)               │
│ • 라우팅에 사용                         │
│ • 목적지까지의 경로 결정                │
│ • 예시: 192.168.0.100 → 8.8.8.8        │
└─────────────────────────────────────────┘

L2 (Data Link Layer) - MAC 주소:
┌─────────────────────────────────────────┐
│ • 로컬 유일성 (같은 네트워크 세그먼트)  │
│ • 물리적 주소 (하드웨어 고정)           │
│ • 스위칭에 사용                         │
│ • 직접 연결된 기기 간 통신              │
│ • 예시: aa:bb:cc:dd:ee:ff               │
└─────────────────────────────────────────┘

주소 매핑의 필요성:
IP는 "어디로 가야 하는가" (Where)
MAC은 "누가 직접 받을 것인가" (Who)
```

### ARP의 기본 기능

**ARP는 이 IP 주소로 MAC 주소를 알아내려고 할 때 사용됩니다. 그러면 과연 언제 남의 PC의 MAC 주소가 필요한 것일까요???**

### Gateway MAC 주소의 중요성

**보통의 PC를 부팅하면 Gateway의 MAC 주소를 찾아내기 위해 ARP Request가 발생하며 이에 대응하는 Reply로 MAC 주소를 알 수 있습니다.(Gateway MAC 주소를 반드시 알아야 인터넷을 사용 가능)**

```
ARP가 필요한 상황들:

1. Gateway와의 통신:
   • 인터넷 접속을 위한 첫 번째 홉
   • 외부 네트워크로의 모든 패킷이 거쳐감
   • Gateway MAC 주소 필수

2. 같은 네트워크 내 직접 통신:
   • 192.168.0.100 → 192.168.0.200
   • 라우터를 거치지 않는 직접 통신
   • 목적지 PC의 MAC 주소 필요

3. 네트워크 서비스 접근:
   • 로컬 DNS 서버 (192.168.0.1)
   • 네트워크 프린터 (192.168.0.10)
   • NAS, 공유 폴더 등

4. 네트워크 진단:
   • ping 테스트
   • traceroute 첫 번째 홉
   • 네트워크 연결 확인
```

### 네트워크 구성과 통신 시나리오

```
네트워크 구성:

PC ──L2──│
         │──────────L2 Distribution
PC ──L2──           │         │
                    │         │
                    │         │
                    PC       Router───────Gateway───────Internet ────── 네이버(ex 3.3.3.3)
```

**이때 Gateway 192.168.0.1번이고 특정 PC 한 대가 부팅해서 DHCP 서버에서 할당받은 IP가 192.168.0.100번이고 이때 네이버하고 통신한다고 가정했을 때를 생각해봅시다.**

### MAC 주소와 IP 주소의 역할 구분

### 흔한 오해와 정확한 이해

**질문!? 네이버의 MAC 어드레스를 모르는데 어떻게 통신할 수 있나요?**

**네이버는 gateway를 나가 인터넷으로 통신하기 때문에 MAC 주소가 아닌 IP 주소로 통신합니다. L3 구간이기 때문입니다. MAC 주소가 중요하게 사용하는 것은 L2 구간에서 중요합니다.**

```
통신 구간별 주소 사용:

로컬 네트워크 구간 (L2):
PC (192.168.0.100) ──── Gateway (192.168.0.1)
│                                    │
└── MAC 주소 필요 ──────────────────┘
   (직접 연결된 세그먼트)

인터넷 구간 (L3):
Gateway (203.0.113.1) ──── 네이버 서버 (223.130.195.200)
│                                          │
└── IP 주소만 사용 ──────────────────────┘
   (라우터 간 라우팅)

핵심 개념:
┌─────────────────────────────────────────┐
│ • MAC 주소: "다음 홉"까지만 유효        │
│ • IP 주소: "최종 목적지"까지 유지       │
│ • 각 라우터에서 MAC 주소는 교체됨       │
│ • IP 주소는 전 구간 동일하게 유지       │
└─────────────────────────────────────────┘
```

### ARP Request/Reply 과정

**이때 네이버에 접속하려는 어느 PC가 있다면 Gateway MAC Address는 반드시 알아야만 합니다. 그렇기 때문에 DHCP broadcast처럼 ARP Request가 나갑니다(이 역시 broadcast). PC에서 192.168.0.1인 host가 있니? 라고 물어보고 이에 해당되지 않는 장치들은 응답하지 않고 해당하는 장치가 ARP Reply를 보내고 이때 MAC 주소도 함께 보냅니다.**

```
ARP Request/Reply 과정:

1. ARP Request (브로드캐스트):
   ┌─────────────────────────────────────────┐
   │ 출발지 MAC: aa:bb:cc:dd:ee:ff (PC)      │
   │ 목적지 MAC: ff:ff:ff:ff:ff:ff (브로드캐스트)│
   │ 출발지 IP: 192.168.0.100               │
   │ 목적지 IP: 192.168.0.1                 │
   │ 질문: "192.168.0.1의 MAC 주소가 뭔가요?"│
   └─────────────────────────────────────────┘

2. 네트워크 내 모든 기기가 수신:
   • PC A: "내 IP가 아니네" (무시)
   • PC B: "내 IP가 아니네" (무시)  
   • Gateway: "내 IP네!" (응답 준비)

3. ARP Reply (유니캐스트):
   ┌─────────────────────────────────────────┐
   │ 출발지 MAC: 12:34:56:78:9a:bc (Gateway)│
   │ 목적지 MAC: aa:bb:cc:dd:ee:ff (PC)      │
   │ 출발지 IP: 192.168.0.1                 │
   │ 목적지 IP: 192.168.0.100               │
   │ 답변: "내 MAC은 12:34:56:78:9a:bc야!"   │
   └─────────────────────────────────────────┘

4. ARP 테이블 업데이트:
   PC의 ARP Cache:
   192.168.0.1 → 12:34:56:78:9a:bc
```

### 실제 패킷 구조와 주소 사용

**그래서 이제 네이버에 PC가 통신하려고 할 때 패킷을 만들어서 통신을 하는데 이때 패킷을 자세하게 보게 된다면...**

### Frame과 IP 패킷의 주소 구조

```
실제 패킷 구조:

┌──────────────────────────────────────────────────────────┐
│                    Ethernet Frame                        │
├─────────────────┬────────────────────────────────────────┤
│  Frame Header   │               IP Packet                │
├─────────────────┼────────────────────────────────────────┤
│ D: Gateway MAC  │ D: 네이버 IP (223.130.195.200)        │
│ S: PC MAC       │ S: PC IP (192.168.0.100)              │
├─────────────────┼────────────────────────────────────────┤
│                 │            TCP + HTTP Data             │
└─────────────────┴────────────────────────────────────────┘
      L2 주소              L3 주소
```

**이때 IP 패킷에서의 출발지는 PC이고 목적지가 네이버일 텐데 IP 패킷을 감싸고 있는 프레임의 출발지는 당연히 PC이지만 이때 목적지를 네이버라고 많이 착각을 하지만 일단 인터넷으로 나가려면 Gateway에 도착해야 하기 때문에 목적지가 Gateway MAC Address가 됩니다.**

### 주소 사용의 논리적 이해

```
패킷 전달 과정의 주소 변화:

1. PC → Gateway 구간:
   ┌─────────────────────────────────────────┐
   │ Frame Header:                           │
   │ • 출발지 MAC: PC MAC                    │
   │ • 목적지 MAC: Gateway MAC ← 중요!       │
   │                                         │
   │ IP Header:                              │
   │ • 출발지 IP: 192.168.0.100              │
   │ • 목적지 IP: 223.130.195.200            │
   └─────────────────────────────────────────┘

2. Gateway → ISP 라우터 구간:
   ┌─────────────────────────────────────────┐
   │ Frame Header: (새로 생성)               │
   │ • 출발지 MAC: Gateway WAN MAC           │
   │ • 목적지 MAC: ISP 라우터 MAC            │
   │                                         │
   │ IP Header: (동일 유지)                  │
   │ • 출발지 IP: 203.0.113.100 (NAT 후)    │
   │ • 목적지 IP: 223.130.195.200            │
   └─────────────────────────────────────────┘

3. 인터넷 백본 구간들:
   각 라우터마다 Frame Header는 새로 생성
   IP Header는 목적지까지 동일하게 유지

핵심 원리:
- Frame: 한 홉(Hop)씩 전달 (MAC 주소)
- IP: 종단간(End-to-End) 전달 (IP 주소)
```

### ARP Cache와 성능 최적화

```
ARP Cache 관리:

ARP 테이블 확인:
Windows: arp -a
Linux: arp -n
macOS: arp -a

예시 출력:
Internet Address      Physical Address      Type
192.168.0.1          12-34-56-78-9a-bc     dynamic
192.168.0.200        aa-bb-cc-dd-ee-ff     dynamic
192.168.0.50         11-22-33-44-55-66     static

Cache 특성:
┌─────────────────────────────────────────┐
│ • 동적 엔트리: 자동 만료 (2-20분)       │
│ • 정적 엔트리: 수동 설정, 영구 보존     │
│ • 만료 시 자동 ARP Request 재전송       │
│ • 네트워크 성능 향상 (재질의 방지)      │
└─────────────────────────────────────────┘

ARP Cache 조작:
# 특정 엔트리 삭제
arp -d 192.168.0.1

# 수동 엔트리 추가
arp -s 192.168.0.1 12-34-56-78-9a-bc

# 전체 캐시 비우기
arp -a -d  # Windows
ip neigh flush all  # Linux
```

이렇게 **ARP의 동작 원리와 실제 패킷에서의 주소 사용 방식을 이해**하면, **네트워크 통신의 핵심 메커니즘을 정확히 파악**할 수 있고, **ARP 관련 문제나 보안 이슈를 효과적으로 해결**할 수 있습니다!