### 패킷의 생성과 전달, 소멸

### 택배 시스템과 네트워크 통신의 완벽한 비유

**사람 A가 B한테 책을 전달하고 싶어 합니다. 이때 A는 B에게 책을 전달할 방법으로 택배를 선택합니다.**

```
택배 배송 과정 vs 네트워크 통신:

택배 시스템                     │ 네트워크 시스템
──────────────────────────────┼─────────────────────────────
사람 A (보내는 사람)          │ Process A (송신 프로세스)
사람 B (받는 사람)            │ Process B (수신 프로세스)  
책 (전달할 물건)              │ Data (전송할 데이터)
택배 박스 (포장)              │ Packet (캡슐화)
택배 송장 (주소 라벨)         │ IP/TCP Header (주소 정보)
택배 기사 (첫 번째 운반자)    │ Gateway (기본 라우터)
물류 시스템 (배송 경로)       │ Routing (경로 선택)
B의 집 주소 (목적지)          │ IP Address (목적지 주소)
B의 이름 (받을 사람)          │ Port Number (목적지 프로세스)
```

### 택배 배송의 세부 과정

**가장 먼저 책을 준비하는 것이 첫 번째이고 책을 택배 박스에 넣고 포장한 다음에 택배 송장을 붙이고 택배를 택배 기사에게 전달하면 기사님은 이런 택배들을 취합한 후에 택배를 전달하기 위해 이동하게 됩니다.**

```
택배 준비 단계별 과정:

1. 물건 준비 (책)
   ↓
2. 박스에 포장 (Encapsulation)
   ↓  
3. 송장 작성 및 부착
   ┌─────────────────────────────────┐
   │ 보내는 사람: A (출발지 주소)    │
   │ 받는 사람: B (목적지 주소)      │  
   │ 연락처: 010-1234-5678 (포트)    │
   └─────────────────────────────────┘
   ↓
4. 택배 기사에게 전달 (Gateway로 전송)
   ↓
5. 기사님이 취합 후 이동 (라우팅 시작)
```

### 물류 시스템의 불투명성

**그러면 택배 기사님은 어디로 갔을까?? 알 수 없습니다. 해당 택배가 어느 지역인지, 어느 회사인지, 어떠한 물류 체계를 가지고 있는지 등에 따라서 이동되게 될 것입니다.**

```
택배 경로의 불확실성 vs 네트워크 라우팅:

택배 물류 경로:
A의 집 → 택배기사 → ??? → ??? → ??? → B의 집
         (수집)     (분류센터들)     (배송)

네트워크 라우팅 경로:  
Host A → Gateway → Router1 → Router2 → ... → Host B
       (기본경로)  (인터넷 백본 경유)      (최종도착)

공통 특성:
- 중간 경로는 발신자가 제어 불가
- 동적 경로 선택 (교통상황/네트워크 상황)
- 최적 경로 자동 선택
- 경로 장애 시 우회 경로 사용
```

### 최종 배달과 수령 과정

**그러면 A가 보낸 택배가 기사님을 통해서 B에게 전달될 것입니다. 우리는 송장에 출발지, 목적지 주소뿐만 아니라 받는 사람에 대한 이름을 기입하게 되어 있습니다.**

### 패킷 전달의 자율성

**일단 A가 택배를 택배 기사님한테 전달한 순간 그 택배는 A의 손을 떠나는 것입니다. 이 전달하는 과정에 있어서 A는 어떠한 개입을 하지 않습니다.**

```
패킷 전달의 자율성:

택배 발송 후:
A → "택배 보냈어!" → [개입 불가] → B

네트워크 전송 후:
Process A → send() → [라우터들이 자율 처리] → Process B

특징:
- 발신 후 제어권 상실
- 중간 과정 개입 불가  
- 네트워크 자체 판단으로 처리
- 결과만 확인 가능 (도착/실패)
```

### 최종 목적지에서의 처리

**또한 기사님은 먼저 일차적으로 목적지 주소를 보고 B의 집까지 찾아가게 됩니다. 이때 B가 혼자 사는 것이 아니라 가족들과 함께 살고 있다면 B가 택배를 직접 받을 수도 있지만 다른 가족들이 받을 수 있습니다. 이때 송장의 이름을 보고 B의 택배이니까 그 택배를 열지 않고 대신 받아서 B에게 전달합니다.**

```
최종 배달 과정:

택배 배달:
택배기사 → B의 집 주소로 이동
         ↓
      가족 중 누군가 수령
         ↓  
      송장의 이름 확인 ("B")
         ↓
      B에게 전달 (박스 그대로)

네트워크 수신:
패킷 → Host B의 IP 주소로 도착
      ↓
   운영체제가 수신
      ↓  
   TCP 헤더의 포트 번호 확인
      ↓
   해당 포트로 리스닝하는 Process B에게 전달
```

### 네트워크 용어로의 정확한 대응

### 프로세스와 데이터 전송

**이제 위의 과정을 구체적으로 말해보자면 이때 사람 A와 B는 프로세스입니다. A 프로세스가 데이터(책)를 B에게 송신해야 하는 것입니다.**

### Gateway의 역할

**그러면 이 데이터를 택배, packet으로 만듭니다. 이 택배를 택배 기사님에게 전달하는데 이때 기사님은 Gateway입니다. 즉 A 집에서 호스트에서 집의 현관이라는 인터페이스를 타고 패킷이 나가게 되는 것인데 이때 현관문이 Gateway입니다.**

```
Gateway의 정확한 의미:

물리적 비유:
집 (Host A) → 현관문 (Gateway) → 외부 세계 (Internet)

네트워크 실제:
Host A → Default Gateway → Internet
192.168.1.100 → 192.168.1.1 → 외부 네트워크

Gateway의 기능:
- 내부 네트워크 → 외부 네트워크 연결점
- 서로 다른 네트워크 간 통신 중재
- 보통 라우터가 Gateway 역할
- NAT(Network Address Translation) 수행
- 방화벽 기능 포함하는 경우 많음
```

### 라우팅과 포트 기반 전달

**목적지는 B 프로세스이지만 1차적으로 이 데이터를 Gateway에게 전달합니다. 그래서 이 Gateway는 택배의 물류 시스템에 따라 전달하는데 이 과정을 라우팅이라고 합니다. 그래서 목적지 IPv4 주소를 가지고 B 프로세스 호스트까지 찾아갑니다. 그 host까지 찾아갔다면 누가 받을지 이름이 중요한데 이 이름이 Port 번호가 됩니다.**

```
주소 체계의 2단계 구조:

1단계: 집 찾기 (IP 주소)
택배: "서울시 강남구 역삼동 123번지"
네트워크: "192.168.1.100"
→ 라우터들이 네트워크 경로 결정

2단계: 사람 찾기 (포트 번호)  
택배: "홍길동 수령"
네트워크: "80번 포트"
→ 호스트 내에서 해당 프로세스에게 전달

전체 주소 체계:
192.168.1.100:80
│            │
└ 집 주소    └ 거주자 이름
└ Host      └ Process
```

### 패킷 생성의 기술적 과정

### 계층별 헤더 추가 과정

```
패킷 생성 과정 (송신 측):

                              Process
                                 │
                               Data
                                 ↓
User Mode              소켓 인터페이스 (TCP/IP 추상화)
─────────────────────────────────────────────────────
Kernel Mode                    TCP
                                 │
                         [TCP Header][Data]
                                 ↓  
                                IP
                                 │
                      [IP Header][TCP Header][Data]
                                 ↓
S/W                           Driver
                                 │
               [Frame Header][IP Header][TCP Header][Data]
─────────────────────────────────────────────────────
H/W                           NIC
                                 │
                          물리적 신호로 변환
```

### 실제 시스템 호출과 데이터 처리

**어떤 프로세스가 인터넷을 통해서 정보를 전달하고자 합니다. 그래서 TCP/IP를 추상화한 파일에 우리가 전송해야 할 데이터를 write 합니다. 근데 우리는 TCP 소켓이기 때문에 write를 send라고 부릅니다.**

소켓 프로그래밍 관점:

C 언어 예시:

```c

// 소켓 생성
int sockfd = socket(AF_INET, SOCK_STREAM, 0);

// 서버에 연결  
connect(sockfd, &server_addr, sizeof(server_addr));

// 데이터 전송 (여기서 캡슐화 시작!)
char* data = "Hello World";
send(sockfd, data, strlen(data), 0);`

```

send() 호출 시 내부 동작:

1. User Mode → Kernel Mode 전환

2. TCP 계층: 데이터에 TCP 헤더 추가

3. IP 계층: TCP 세그먼트에 IP 헤더 추가

4. Driver: IP 패킷에 Ethernet 헤더 추가

5. NIC: 프레임을 전기신호로 변환

6. 물리적 전송

계층별 캡슐화 세부 과정

그래서 인터페이스를 통해서 TCP를 만나게 되면 이 데이터에 TCP 헤더라는 것을 붙여서 segment라고 하는 단위 데이터를 만듭니다. 이게 한층 더 내려가게 되면 그 앞에 IP 헤더가 하나 더 붙게 됩니다. 이제 이게 한층 더 내려가면 앞에 frame header가 붙게 됩니다.

단계별 데이터 변환:

1단계 (L4 - TCP):
원본: "Hello World"
처리: TCP 헤더 추가
결과: [TCP Header]["Hello World"] = TCP Segment

2단계 (L3 - IP):

입력: [TCP Header]["Hello World"]
처리: IP 헤더 추가
결과: [IP Header][TCP Header]["Hello World"] = IP Packet

3단계 (L2 - Ethernet):
입력: [IP Header][TCP Header]["Hello World"]

처리: Frame 헤더 추가
결과: [Frame Header][IP Header][TCP Header]["Hello World"] = Ethernet Frame

각 헤더의 역할:

- TCP Header: 포트, 순서번호, 흐름제어
- IP Header: 출발지/목적지 IP, 라우팅 정보
- Frame Header: 출발지/목적지 MAC, 프레임 타입

네트워크로의 송출
그래서 이 frame header 붙은 통째로 데이터가 NIC를 통해 밖으로 나가게 됩니다. 그래서 L2 Access 스위치를 만나서 라우터와 라우트 게이트웨이를 만나서 인터넷으로 나가게 됩니다.

네트워크 전송 경로:

```
Host A의 NIC
↓ (Frame 송출)
L2 Access Switch

↓ (MAC 주소 기반 스위칭)
L2 Distribution Switch
↓ (상위 계층으로 집약)

L3 Router (Gateway)
↓ (IP 주소 기반 라우팅)
Internet Backbone
↓ (여러 라우터 경유)
목적지 ISP Router
↓
목적지 Gateway
↓
목적지 L2 Switch
↓

Host B의 NIC
↓ (Frame 수신)
Host B에서 역순 Decapsulation
```

각 단계에서:

- L2 장비: Frame Header만 확인
- L3 장비: IP Header까지 확인
- 최종 목적지: 모든 헤더 순차 제거

이렇게 택배 시스템과의 완벽한 비유를 통해 패킷의 생성부터 소멸까지의 전 과정을 이해하면, 네트워크 통신이 단순한 기술이 아니라 우리 일상의 물류 시스템과 동일한 원리로 동작한다는 것을 깊이 있게 파악할 수 있습니다!