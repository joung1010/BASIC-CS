# 대규모 부하분산을 위한 GSLB

## GSLB의 필요성과 개념
**로드밸런싱을 하는데 L4 스위치 하나 가지고 하면 호스트 하나를 여러 개로 분산해서 호스트가 하나의 호스트인 것처럼 보이는 것이다. 이때 이 호스트 하나를 확장하게 되면 Global로 가는 것이다. 즉 세계 수준에서 전체 지도를 펼쳐 놓고 얘기한다는 것이다**.

Global Server Load Balancing(GSLB)는 앞서 학습한 L4 로드밸런싱의 확장된 개념입니다. **L4 로드밸런싱이 단일 데이터센터 내에서 여러 서버로 트래픽을 분산했다면, GSLB는 전 세계에 분산된 여러 데이터센터로 트래픽을 분산**합니다.

**구글, 네이버 등 이런 글로벌 서비스를 제공하는 업체들은 이 밸런싱 문제가 진짜 어렵다. 근데 이 글로벌 서버들의 상당수가 웹서버이다. 당연하게도 이 DNS와도 연결되어 있다. 그래서 이 글로벌하게 부하를 분산할 때 활용되는 것이 DNS를 활용하게 된다**.

```
GSLB의 핵심 구성 요소:

- DNS 기반 트래픽 분산
- 지리적 위치 기반 라우팅
- 서버 상태 및 부하 모니터링
- CDN과의 연동
- 실시간 헬스체크
```

GSLB가 해결하는 근본적인 문제는 **물리적 거리에 따른 네트워크 지연**입니다. 한국의 사용자가 미국에 있는 서버에 접속하면 최소 150ms 이상의 지연이 발생하는데, 이는 실시간 서비스나 대용량 콘텐츠 전송에 치명적입니다.

## CDN과 콘텐츠 동기화

그래서 **넷플릭스나 구글과 같이 콘텐츠를 많이 가지고 있는 업체들이 호스트 하나에 여러 호스트들로 분산에서 처리하는 구조에서 만약에 특정 콘텐츠 하나를 업로드한다고 했을 때 한 서버에만 콘텐츠가 업로드되면 안 되고 모든 서버에 콘텐츠가 업로드되어야 한다. 그런데 이런 서버들이 전세계에 퍼져있다면 너무 머리가 아파진다**.

**그래서 모든 서버에 업데이트를 한 번에 동시에 처리하게 해주는 전문 네트워크가 따로 존재하는데 이를 CDN(Contents Delivery Network)이다. 그래서 서버가 여러 대 존재한다 하더라도 이 콘텐츠가 같아야 하기 때문이다**.

CDN의 동작 방식을 구체적으로 살펴보면, **Origin Server**라는 원본 서버에 콘텐츠가 최초로 업로드됩니다. 그러면 CDN 제공업체의 관리 시스템이 이 콘텐츠를 전 세계에 분산된 **Edge Server**들로 복제합니다.

이 과정에서 중요한 것은 **콘텐츠 무결성 검증**입니다. 각 Edge Server로 복제되는 파일들이 원본과 동일한지 해시값을 비교하여 검증합니다. 또한 **버전 관리**를 통해 특정 버전의 콘텐츠가 모든 서버에 정확히 배포되었는지 확인합니다.

```
CDN 콘텐츠 동기화 과정:

Origin Server (원본)
    ↓ (콘텐츠 업로드)
CDN Management System
    ↓ (복제 및 배포)
┌─────────────────────────────────────┐
│ Edge Server 1  Edge Server 2  Edge Server 3
│ (아시아)        (유럽)         (북미)
└─────────────────────────────────────┘
    ↓ (사용자 요청 처리)
지역별 사용자들
```

## DNS 기반 GSLB 동작 원리

```
       3.3.3.100 <             인터넷                             >
         PC ─────| ──────────────ISP(DNS#1)
     4.4.4.100   |               │
         PC ─────|               │──────────Web Server  #1
                 |                          a.www.abc.com
                 |                            IP:3.3.3.3
                 |                            
                 |          ..ISP(DNS#2)                ..ISP(DNS#3)  
                 |          |                           |
                             ---- Web Server #2          ----Web Server #3
                 .                 c.www.abc.com             b.www.abc.com
                 .                   IP:4.4.4.4              IP:5.5.5.5
    5.5.5.100    .                   
      PC   ------                            
                  ----------------------------------------------------------
```

**위의 이 abc 사이트는 넷플릭스처럼 속도가 매우 중요한 영상 제공 서비스 업체라고 가정해보자**.

**이때 이 abc 웹서버가 한 대밖에 없다면 모든 클라이언트가 전부 이 한 대에 접속할 것이고 그 서버에 로드밸런스를 붙여서 뒤에 여러 서버들로 구성해야 될 텐데 이러한 구성으로도 이 트래픽 처리가 힘들 수도 있을 것이다. 이러한 상황에서 GSLB를 적용하는 것이다**.

DNS 기반 GSLB의 핵심은 **동일한 도메인명에 대해 클라이언트의 위치에 따라 다른 IP 주소를 응답**하는 것입니다.

**만약에 이 ISP와 함께 물려있는 서버는 굉장히 빠를 것이다. 그래서 이 ISP 업체마다 별도의 서버를 전부 따로 두게 된다. 그래서 3.3.3.100번이 abc 사이트 IP 좀 알려줘 하면 3.3.3.100이 사용하는 ISP에서 이 abc의 IP 주소를 직접 알려주는 것이 아니라 어떤 alias 별칭과 같은 canonical name(a.[www.abc.com)을](http://www.abc.xn--com)-jy1s/) 알려주는 것이다. 그래서 그 별칭을 응답받은 클라이언트가 다시 별칭을 가지고 IP 주소를 물어보면 그때 3.3.3.3번의 IP 주소를 리턴하게 된다**.

```
DNS 기반 GSLB 질의 과정:

1. 클라이언트 → 로컬 DNS: "www.abc.com의 IP는?"

2. 로컬 DNS → 권한 DNS: "www.abc.com의 IP는?"

3. 권한 DNS 응답: "CNAME: a.www.abc.com"
   (지리적 위치에 따른 별칭 반환)

4. 로컬 DNS → 권한 DNS: "a.www.abc.com의 IP는?"

5. 권한 DNS 응답: "A Record: 3.3.3.3"
   (가장 가까운 서버 IP 반환)

6. 로컬 DNS → 클라이언트: "3.3.3.3"

7. 클라이언트 → 3.3.3.3로 HTTP 연결
```

이 과정에서 **권한 DNS 서버가 GSLB의 핵심 역할**을 담당합니다. 이 서버는 다음과 같은 정보들을 종합하여 최적의 서버를 선택합니다:

**서버 헬스 상태**: 각 지역 서버의 CPU, 메모리, 네트워크 상태를 실시간으로 모니터링합니다. 장애가 발생한 서버는 즉시 DNS 응답에서 제외됩니다.

**서버 부하 상태**: 현재 각 서버가 처리 중인 동시 연결 수, 응답 시간, 처리량 등을 고려하여 가장 여유로운 서버를 선택합니다.

**네트워크 거리**: 클라이언트와 각 서버 간의 네트워크 홉 수, RTT(Round Trip Time) 등을 측정하여 물리적으로 가장 가까운 서버를 우선 선택합니다.

## 지리적 위치 기반 라우팅

**그래서 앞서 health check 시에 글로벌로 개념이 확장되다 보니 사용자의 지리적 위치 또한 고려되어야 한다**.

**그러면 글로벌로 확장되었을 때 이 클라이언트의 지리적 위치는 어떻게 알 수 있는 것일까? 바로 IP 주소 가지고 알 수 있다. 그래서 어떤 IP 주소가 어떤 지역에 속했는지를 판매하는 데이터베이스가 별도로 존재한다**.

이 데이터베이스를 **GeoIP 데이터베이스**라고 합니다. 이는 전 세계 IP 주소 블록이 어느 국가, 어느 도시, 심지어 어느 ISP에 할당되었는지에 대한 정보를 담고 있습니다.

```
GeoIP 매핑 예시:

3.3.3.0/24    → 한국, 서울, KT
4.4.4.0/24    → 미국, 캘리포니아, Comcast  
5.5.5.0/24    → 일본, 도쿄, NTT
6.6.6.0/24    → 독일, 베를린, Deutsche Telekom
```

**GSLB 시스템은 이 GeoIP 정보를 활용하여 클라이언트의 DNS 쿼리가 들어오면 해당 IP의 지리적 위치를 파악**합니다. 그리고 그 위치에서 가장 가까운 데이터센터의 서버 IP를 응답합니다.

하지만 여기서 중요한 점은 **DNS 쿼리를 보내는 IP가 항상 최종 사용자의 IP는 아니**라는 것입니다. 대부분의 경우 ISP의 DNS 서버 IP이므로, 실제로는 ISP의 위치를 기준으로 가장 가까운 서버를 선택하게 됩니다.

## ISP 기반 트래픽 최적화

**그래서 ISP 내부에서 트래픽이 발생하다 보니까 바깥으로 복잡하게 돌아다닐 일도 없고 입출력 성능, 네트워크 성능도 훨씬 더 빠르고 쾌적하게 콘텐츠를 즐길 수 있게 되는 것이다**.

이는 네트워크 토폴로지 관점에서 매우 중요한 최적화입니다. **일반적으로 ISP 간 연결(Inter-ISP)보다 ISP 내부 연결(Intra-ISP)이 훨씬 빠르고 안정적**입니다.

예를 들어, KT 사용자가 KT 네트워크 내에 있는 서버에 접속하면 KT의 백본 네트워크만을 통해 통신이 이루어집니다. 하지만 해외 서버에 접속하면 KT → 해외 ISP → 목적지 서버의 경로를 거쳐야 하므로 지연시간이 증가하고 패킷 손실 가능성도 높아집니다.

```
트래픽 경로 비교:

로컬 서버 접속:
클라이언트 → KT 라우터 → KT 백본 → 로컬 서버
(홉 수: 3-5개, 지연시간: 10-30ms)

해외 서버 접속:  
클라이언트 → KT 라우터 → 해외 연결점 → 해외 ISP → 해외 서버
(홉 수: 15-25개, 지연시간: 150-300ms)
```

## CDN 업체와 관리 시스템

**그런데 이때 이 각 서버 전체들을 관리하는 개념인 매니저가 존재해야 하고 이 콘텐츠들을 어떻게 동기화할 것인가가 중요한 이슈로 작용된다. 그래서 보통은 이 CDN만을 제공하는 업체들이 별도로 존재하고 그 회사에 콘텐츠 하나를 올려두면 그 회사가 매니저 같은 시스템으로 전세계에 콘텐츠를 퍼뜨려주는 것이다**.

대표적인 CDN 업체로는 Cloudflare, Amazon CloudFront, Akamai, Fastly 등이 있습니다. 이들은 **전 세계에 수백 개의 PoP(Point of Presence)**를 운영하며, 각 PoP에는 수십 대에서 수백 대의 캐시 서버가 있습니다.

CDN 관리 시스템의 핵심 기능들은 다음과 같습니다:

**콘텐츠 배포 관리**: Origin Server에서 Edge Server로의 콘텐츠 복제를 자동화하고, 복제 완료 여부를 실시간으로 추적합니다.

**캐시 관리**: 인기 있는 콘텐츠는 더 많은 Edge Server에 복제하고, 사용 빈도가 낮은 콘텐츠는 일부 서버에서 삭제하여 저장 공간을 효율적으로 관리합니다.

**무효화(Invalidation) 관리**: 콘텐츠가 업데이트되면 전 세계 모든 Edge Server의 해당 콘텐츠를 즉시 삭제하거나 업데이트합니다.

**실시간 모니터링**: 각 Edge Server의 상태, 트래픽, 에러율 등을 실시간으로 모니터링하고, 문제 발생 시 자동으로 트래픽을 다른 서버로 우회시킵니다.

```
CDN 관리 아키텍처:

[Origin Server] ← 콘텐츠 업로드
     ↓
[CDN Management System]
     ↓ (배포 명령)
┌─────────────────────────────────────┐
│ PoP 1     PoP 2     PoP 3     PoP N │
│ (서울)    (도쿄)   (싱가포르) (시드니)│
└─────────────────────────────────────┘
     ↑ (상태 보고)
[모니터링 및 제어 시스템]
```

**지금 위의 개념을 ISP가 아니라 각 나라로 생각해도 동일한 방식으로 구성되어서 처리되어진다**. 실제로 대부분의 글로벌 서비스들은 국가별로 데이터센터를 운영하며, 각 국가의 인터넷 인프라와 법적 규제를 고려하여 최적화된 서비스를 제공합니다.

이러한 GSLB와 CDN의 결합은 현대 인터넷 서비스의 핵심 인프라가 되었으며, 사용자들이 전 세계 어디서든 빠르고 안정적인 서비스를 이용할 수 있게 해주는 기반 기술입니다.