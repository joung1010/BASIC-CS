# Proxy 구조(우회)

## Proxy 서버의 기본 구조

```
             
            Private 192.168.0.1
            Global 3.3.3.3  
192.168.0.10    NAT Gateway                              10.10.10.20
             PC ──→ 라우터  ──→ 인터넷 ------ 라우터 ------ 웹서버    
                │                 │                        │
                │                 │ 70.70.70.70            │
                │                 │──→ 프록시                │   TCP Connection #2
                │                 │                        │
                └─────────────── 프록시 ─────────────────────┘
                    TCP       50.50.50.50                                          
                   Connection #1
```

**프록시는 보통 프록시 서버라고 말하고 항상 소켓 + 스트림 수준의 데이터를 처리**한다. **만약 내 개인 컴퓨터로 미국에 있는 어떤 서버에 접속한다고 한다면 그냥 바로 인터넷을 통해 미국에 있는 웹서버에 접속하면 된다. 이렇게 직접 접속하게 되면 웹서버 입장에서 한국에 있는 192.168.0.10이 나한테 접속을 했구나 라고 할 수 있다. 근데 이때 나라는 존재를 웹서버가 인식하지 못하게 하고 싶다**.

**그럴 때 사용할 수 있는 것이 어떤 프록시 서버라는 것을 이용하면 된다. 브라우저 설정에 보면 프록시 서버 설정이 존재한다**. **예를 들어 만약에 50.50.50.50이 IP가 속한 지리적 위치가 실제 독일이라면 내가 프록시 서버를 통해서 미국의 웹서버에 접속하게 되면 웹서버 입장에서 출발지 IP가 50.50.50.50인 독일이 된다**.

```
프록시를 통한 IP 우회:

직접 접속:
┌─────────────────────────────────────────────────┐
│ 한국 PC (192.168.0.10) ──→ 미국 웹서버         │
│                                                 │
│ 웹서버가 보는 접속자: 한국 IP                   │
│ 지리적 위치: 한국                               │
│ ISP 추적: 가능                                  │
└─────────────────────────────────────────────────┘

프록시 경유 접속:
┌─────────────────────────────────────────────────┐
│ 한국 PC ──→ 독일 프록시 ──→ 미국 웹서버        │
│                                                 │
│ 웹서버가 보는 접속자: 독일 프록시 IP            │
│ 지리적 위치: 독일                               │
│ 실제 사용자: 한국 (서버는 모름)                 │
└─────────────────────────────────────────────────┘

브라우저 프록시 설정:
┌─────────────────────────────────────────────────┐
│ HTTP 프록시: 50.50.50.50:8080                  │
│ HTTPS 프록시: 50.50.50.50:8443                 │
│ SOCKS 프록시: 50.50.50.50:1080                 │
│                                                 │
│ 예외 사이트: localhost, *.company.com           │
│ 자동 구성: PAC 파일 사용                        │
└─────────────────────────────────────────────────┘
```

그래서 **내 컴퓨터는 가만히 한 곳에 있는데 미국의 웹서버 입장에서는 출발지 IP가 프록시 IP의 실제 위치에 따라 독일, 영국이 될 수 있는 것**이다.

## 프록시 사용 목적

**이렇게 프록시를 이용해서 서버에 접근하는 가장 큰 이유는 자신을 속이기 위해서**이다. **예를 들어 ISP에서 미국쪽 접근을 완전히 차단하고 있는데 나는 반드시 미국쪽 주소에 접근이 필요할 때 프록시 서버를 변경함으로써 직접 접속하는 것이 아니라 프록시 서버를 경유하게 됨으로써 가능하게 된다**.

**당연히 직접 접속보다 한 번 돌아서 접근하기 때문에 직접 접속하는 것보다 속도가 느릴 수 있다**.

그래서 **프록시 서버를 보통 대리자, 대리인의 역할을 하는 것**이다.

```
프록시 사용 사례:

우회 접속:
┌─────────────────────────────────────────────────┐
│ 차단된 사이트 접근:                             │
│ • 지역 제한 콘텐츠 (Netflix, YouTube)           │
│ • 정부 검열 우회                                │
│ • 기업 방화벽 우회                              │
│                                                 │
│ 예시: 중국에서 구글 접속                        │
│ 중국 PC ──→ 홍콩 프록시 ──→ 구글               │
└─────────────────────────────────────────────────┘

익명성 보장:
┌─────────────────────────────────────────────────┐
│ 개인정보 보호:                                  │
│ • 실제 IP 주소 숨김                            │
│ • 웹사이트 추적 방지                            │
│ • 광고 타겟팅 방지                              │
│                                                 │
│ 보안 강화:                                      │
│ • 공용 WiFi에서 안전한 접속                     │
│ • 정부 감시 회피                                │
│ • 기업 스파이 방지                              │
└─────────────────────────────────────────────────┘

성능 최적화:
┌─────────────────────────────────────────────────┐
│ 캐싱:                                           │
│ • 자주 방문하는 사이트 캐시                      │
│ • 대역폭 절약                                   │
│ • 로딩 속도 향상                                │
│                                                 │
│ 압축:                                           │
│ • 데이터 압축으로 전송량 감소                   │
│ • 느린 네트워크에서 유용                        │
└─────────────────────────────────────────────────┘

기업 정책:
┌─────────────────────────────────────────────────┐
│ 접근 제어:                                      │
│ • 특정 사이트 차단                              │
│ • 업무 시간 제한                                │
│ • 대역폭 관리                                   │
│                                                 │
│ 모니터링:                                       │
│ • 직원 인터넷 사용 기록                         │
│ • 보안 정책 준수                                │
│ • 데이터 유출 방지                              │
└─────────────────────────────────────────────────┘
```

## 프록시 서버 내부 구조

```
                         Process                      
                                             
User Mode           소켓(Listen)   소켓(Client)                                                       
─────────────────────────────────────────────────────────────
Kernel Mode    ┌──────────────────────┐       
               │        TCP           │                  
               └──────────────────────┘       
               ┌────────────────────────┐     
               │        IP              │   70.70.70.70            
               └────────────────────────┘    
                                              
               ┌──────────────────────────┐             
               │       Driver             │             
S/W            └──────────────────────────┘                                                                                                  
─────────────────────────────────────────────────────────────
H/W                      NIC
```

**프록시 서버는 보통 2개의 소켓을 열어두고 하나는 접속을 받기 위한 소켓, 그래서 어떤 사용자가 외국의 어떤 사이트에 접속을 요청하면 그 요청을 듣고 내부적으로 클라이언트 역할을 하는 소켓을 열어서 해당 사이트에 접속을 시도한다**.

**이때 프록시 서버가 원 접속자의 정보를 서버에 알려주지 않는다면 미국 쪽 서버에서는 원래 누가 접속하려고 했는지 인지할 수 없다**.

```
프록시 서버 소켓 구조:

듀얼 소켓 아키텍처:
┌─────────────────────────────────────────────────┐
│ 프록시 서버 (50.50.50.50)                       │
│                                                 │
│ ┌─────────────┐     ┌─────────────┐             │
│ │Server Socket│     │Client Socket│             │
│ │  (Listen)   │     │ (Connect)   │             │
│ │   :8080     │     │   →외부서버  │             │
│ └─────────────┘     └─────────────┘             │
│        ↑                   ↓                   │
│   클라이언트 요청      실제 서버 요청             │
│      수신               전달                    │
└─────────────────────────────────────────────────┘

연결 흐름:
┌─────────────────────────────────────────────────┐
│ 1. 클라이언트 ──→ 프록시 (Server Socket)        │
│ 2. 프록시 파싱 ──→ 목적지 확인                  │
│ 3. 프록시 ──→ 실제 서버 (Client Socket)        │
│ 4. 서버 응답 ──→ 프록시                        │
│ 5. 프록시 ──→ 클라이언트 (응답 전달)            │
└─────────────────────────────────────────────────┘
```

## 프록시 유형별 특성

```
Forward Proxy (포워드 프록시):
┌─────────────────────────────────────────────────┐
│ 클라이언트 ──→ Forward Proxy ──→ 인터넷         │
│                                                 │
│ 용도:                                           │
│ • 기업 내부 직원들의 인터넷 접속 제어           │
│ • 캐싱을 통한 성능 향상                         │
│ • 접속 로그 및 모니터링                         │
│ • 악성 사이트 차단                              │
│                                                 │
│ 특징:                                           │
│ • 클라이언트가 프록시 설정 필요                 │
│ • 서버는 프록시 존재 인식 못함                  │
│ • 기업 환경에서 주로 사용                       │
└─────────────────────────────────────────────────┘

Reverse Proxy (리버스 프록시):
┌─────────────────────────────────────────────────┐
│ 인터넷 ──→ Reverse Proxy ──→ 내부 서버          │
│                                                 │
│ 용도:                                           │
│ • 웹서버 보호 (실제 서버 IP 숨김)               │
│ • 로드 밸런싱 (여러 서버로 분산)                │
│ • SSL 터미네이션                               │
│ • 캐싱 및 압축                                  │
│                                                 │
│ 특징:                                           │
│ • 클라이언트는 프록시 존재 모름                 │
│ • 서버 대신 요청 처리                           │
│ • 웹서비스 환경에서 주로 사용                   │
│                                                 │
│ 예시: Nginx, Apache HTTP Server                │
└─────────────────────────────────────────────────┘

Transparent Proxy (투명 프록시):
┌─────────────────────────────────────────────────┐
│ 클라이언트 ──→ 투명 프록시 ──→ 인터넷           │
│                                                 │
│ 특징:                                           │
│ • 클라이언트 설정 불필요                        │
│ • 네트워크 레벨에서 자동 리다이렉트             │
│ • 사용자가 프록시 존재 인식 못함                │
│                                                 │
│ 구현:                                           │
│ • 라우터/방화벽에서 트래픽 가로채기             │
│ • iptables REDIRECT 규칙                       │
│ • 브릿지 모드 프록시                            │
│                                                 │
│ 용도:                                           │
│ • ISP 레벨 캐싱                                │
│ • 기업 정책 강제 적용                           │
│ • 트래픽 분석 및 모니터링                       │
└─────────────────────────────────────────────────┘
```

이러한 **프록시 구조**를 이해하면 **네트워크 보안, 접근 제어, 성능 최적화, 그리고 개인정보 보호** 등 다양한 목적에 따라 **적절한 프록시 솔루션을 선택하고 구현**할 수 있습니다.


# Proxy 보호와 감시

## 기업 환경의 프록시 구조

```
            Private 192.168.0.1
            Global 3.3.3.3  
192.168.0.10    NAT Gateway 침입 방지 시스템                10.10.10.20
             PC ──→ 라우터──→ IPS ─인터넷 ------ 라우터 ------ 웹서버    
                │     │                                    │
                │     │                                    │
                │   L2 Distribution                        │   TCP Connection #2
                │     Switch                               │
                │     │                                    │                   
                │     │                                    │
                │     │                                    │
                └────프록시 ─────────────────────────────────┘
                    TCP       192.168.0.200                                         
                   Connection #1
```

**앞서 프록시의 여러 형태 중 하나인 우회에 대해 알아봤다면 다른 형태인 보호와 감시의 역할을 하는 프록시 형태도 존재**한다. **우리가 PC에서 HTTP 통신을 통해서 어떤 웹서버에 접속한다고 했을 때 특정 기업과 같은 경우 보안을 목적으로 PC들이 인터넷 사용을 못하게 막기도 한다. 즉 PC가 바로 인터넷으로 나가는 게 아니라 IPS 이런 곳에서 내부망을 통제하겠다. 그러면 PC 사용자에게 프록시 서버를 설정해서 우회 목적이 아닌 감시의 역할로써 사용**된다.

**앞의 우회에서는 프록시 서버가 인터넷망에 나가 있었다면 이번 프록시 서버는 내부망 안에 존재하면 이 내부망 프록시를 통해서만 인터넷으로 나갈 수 있게끔 하는 것**이다.

```
프록시 위치에 따른 목적 비교:

외부 프록시 (우회 목적):
┌─────────────────────────────────────────────────┐
│ 기업 내부 ──→ 인터넷 ──→ [외부 프록시] ──→ 목표 서버 │
│                                                 │
│ 목적:                                           │
│ • 지역 제한 우회                                │
│ • 익명성 확보                                   │
│ • 검열 회피                                     │
│                                                 │
│ 특징:                                           │
│ • 사용자 의도적 설정                            │
│ • 기업 정책 우회                                │
│ • 개인적 목적                                   │
└─────────────────────────────────────────────────┘

내부 프록시 (보호/감시 목적):
┌─────────────────────────────────────────────────┐
│ PC ──→ [내부 프록시] ──→ 인터넷 ──→ 목표 서버     │
│                                                 │
│ 목적:                                           │
│ • 직원 활동 모니터링                            │
│ • 보안 정책 강제                                │
│ • 악성코드 차단                                 │
│ • 데이터 유출 방지                              │
│                                                 │
│ 특징:                                           │
│ • 기업 정책으로 강제                            │
│ • 모든 트래픽 중앙 집중                         │
│ • 로그 및 분석                                  │
└─────────────────────────────────────────────────┘
```

## 감시와 모니터링 기능

그래서 **이게 왜 감시냐 하면 직접 인터넷으로 나가는 것은 불가능하지만 이 프록시를 거쳐서는 인터넷으로 나갈 수 있기 때문에 누가 언제 몇 시에 어디에 접속했는지 알 수 있는 것**이다.

그래서 **만약에 여기서 HTTP 트래픽을 모니터링하면 특정 인원이 만약에 근무시간에 증권사 사이트에 접속한다고 했을 때 이러한 근무 외 다른 행위를 감시, 즉 내부 직원을 감시할 수도 있는 것**이다.

```
기업 프록시 모니터링 시스템:

접속 로그 수집:
┌─────────────────────────────────────────────────┐
│ 로그 정보:                                      │
│ • 사용자 ID: kim.gildong                        │
│ • 시간: 2024-01-15 14:30:25                    │
│ • 접속 URL: https://stock.naver.com             │
│ • 사용 시간: 15분 30초                          │
│ • 다운로드 용량: 2.5MB                         │
│ • User-Agent: Chrome/120.0.0.0                 │
│                                                 │
│ 분석 가능 항목:                                 │
│ • 업무시간 중 개인적 사이트 접속                │
│ • 금지된 카테고리 사이트 접속                   │
│ • 과도한 대역폭 사용                            │
│ • 의심스러운 파일 다운로드                      │
└─────────────────────────────────────────────────┘

정책 기반 차단:
┌─────────────────────────────────────────────────┐
│ 카테고리별 정책:                                │
│ • 소셜미디어: 점심시간만 허용                   │
│ • 동영상 스트리밍: 전면 차단                    │
│ • 온라인 쇼핑: 업무시간 차단                    │
│ • 파일 공유: 승인된 사이트만                    │
│                                                 │
│ 시간대별 정책:                                  │
│ • 09:00-12:00: 업무 관련 사이트만               │
│ • 12:00-13:00: 제한 완화                       │
│ • 13:00-18:00: 업무 관련 사이트만               │
│ • 18:00 이후: 자유 접속                        │
└─────────────────────────────────────────────────┘

실시간 알림:
┌─────────────────────────────────────────────────┐
│ 경고 시나리오:                                  │
│ • 금지 사이트 접속 시도                         │
│ • 대용량 파일 다운로드                          │
│ • 업무시간 중 장시간 개인 사이트 이용           │
│ • 의심스러운 도메인 접속                        │
│                                                 │
│ 대응 조치:                                      │
│ • 즉시 연결 차단                                │
│ • 관리자에게 알림                               │
│ • 사용자에게 경고 메시지                        │
│ • 로그 기록 및 보고서 생성                      │
└─────────────────────────────────────────────────┘
```

## 보안 스캔과 파일 검사

근데 **단순 감시의 목적만이 아니라 외부에서 어떤 파일을 다운로드받았을 때 이 파일이 프록시 서버에 다운로드될 것이고 프록시 서버는 이 파일에 바이러스가 포함되어 있는지 검사할 수 있다. 검사 후 문제가 없으면 PC에 데이터를 전달한다. 보안 목적의 외부 데이터 감시를 할 수 있는 것**이다.

```
프록시 기반 보안 스캔:

파일 다운로드 프로세스:
┌─────────────────────────────────────────────────┐
│ 1. 사용자가 파일 다운로드 요청                   │
│ 2. 프록시가 외부 서버에서 파일 수신             │
│ 3. 프록시 임시 저장소에 파일 보관               │
│ 4. 보안 엔진이 파일 스캔 시작                   │
│    ├─ 바이러스 검사 (시그니처 기반)             │
│    ├─ 행위 분석 (샌드박스)                      │
│    ├─ 파일 형식 검증                            │
│    └─ 악성 URL 포함 여부                       │
│ 5. 스캔 결과에 따른 처리                        │
│    ├─ 안전: 사용자에게 전달                     │
│    ├─ 위험: 격리/삭제                          │
│    └─ 의심: 추가 분석 요청                     │
└─────────────────────────────────────────────────┘

멀티 레이어 보안 검사:
┌─────────────────────────────────────────────────┐
│ 1차: 실시간 스캔                                │
│ • ClamAV, Symantec 등 안티바이러스              │
│ • 알려진 악성 파일 해시 검사                    │
│ • 빠른 처리 (수 초 이내)                       │
│                                                 │
│ 2차: 심층 분석                                  │
│ • 샌드박스 환경에서 파일 실행                   │
│ • 행위 패턴 분석                                │
│ • 네트워크 통신 모니터링                        │
│ • 처리 시간: 수 분~수십 분                     │
│                                                 │
│ 3차: 위협 인텔리전스                            │
│ • 외부 위협 DB와 연동                          │
│ • 최신 IOC (Indicator of Compromise) 검사      │
│ • 파일 출처 신뢰도 평가                         │
└─────────────────────────────────────────────────┘

파일 타입별 검사:
┌─────────────────────────────────────────────────┐
│ 실행 파일 (.exe, .msi, .bat):                   │
│ • 디지털 서명 검증                              │
│ • 패킹/난독화 탐지                              │
│ • API 호출 패턴 분석                           │
│                                                 │
│ 문서 파일 (.pdf, .doc, .xls):                   │
│ • 매크로 코드 검사                              │
│ • 임베디드 객체 분석                            │
│ • 익스플로잇 시그니처 검사                      │
│                                                 │
│ 압축 파일 (.zip, .rar, .7z):                    │
│ • 재귀적 압축 해제                              │
│ • 내부 파일 개별 검사                           │
│ • 압축 폭탄 탐지                                │
└─────────────────────────────────────────────────┘
```

## IPS vs 프록시 비교

**IPS는 패킷 단위의 단편화된 데이터만 확인할 수 있지만 이렇게 프록시를 이용하면 HTTP의 스트림 데이터를 모두 다 볼 수 있기 때문에 파일을 추출해서 보는 데 매우 유리**하다.

```
IPS vs 프록시 기능 비교:

IPS (Intrusion Prevention System):
┌─────────────────────────────────────────────────┐
│ 처리 레벨: 패킷 (L3-L4)                         │
│                                                 │
│ 장점:                                           │
│ • 높은 처리 속도 (하드웨어 기반)                │
│ • 모든 프로토콜 지원                            │
│ • 네트워크 투명성                               │
│ • 실시간 차단                                   │
│                                                 │
│ 단점:                                           │
│ • 단편화된 패킷만 분석                          │
│ • 암호화된 트래픽 분석 제한                     │
│ • 애플리케이션 컨텍스트 부족                    │
│ • 파일 재조립 복잡                              │
│                                                 │
│ 탐지 가능:                                      │
│ • 네트워크 스캔                                 │
│ • 프로토콜 이상                                 │
│ • 알려진 공격 시그니처                          │
│ • DoS/DDoS 공격                                │
└─────────────────────────────────────────────────┘

프록시 (Application Layer):
┌─────────────────────────────────────────────────┐
│ 처리 레벨: 애플리케이션 (L7)                    │
│                                                 │
│ 장점:                                           │
│ • 완전한 HTTP 스트림 분석                      │
│ • 파일 내용 전체 검사                           │
│ • 사용자 행위 분석                              │
│ • 정교한 정책 적용                              │
│                                                 │
│ 단점:                                           │
│ • 상대적으로 느린 처리                          │
│ • 높은 리소스 사용                              │
│ • 프로토콜 제한 (주로 HTTP/HTTPS)               │
│ • 단일 장애점                                   │
│                                                 │
│ 분석 가능:                                      │
│ • 웹 애플리케이션 공격                          │
│ • 데이터 유출                                   │
│ • 악성 파일 다운로드                            │
│ • 사용자 행위 패턴                              │
└─────────────────────────────────────────────────┘

상호 보완적 배치:
┌─────────────────────────────────────────────────┐
│ 계층별 보안 전략:                               │
│                                                 │
│ 1단계: 방화벽 (L3-L4)                          │
│ • 기본적인 포트/프로토콜 필터링                 │
│                                                 │
│ 2단계: IPS (L3-L4)                             │
│ • 네트워크 공격 차단                            │
│ • 실시간 위협 탐지                              │
│                                                 │
│ 3단계: 프록시 (L7)                             │
│ • 애플리케이션 레벨 보안                        │
│ • 상세한 콘텐츠 분석                            │
│                                                 │
│ 4단계: 엔드포인트 보안                          │
│ • 안티바이러스                                  │
│ • EDR (Endpoint Detection Response)            │
└─────────────────────────────────────────────────┘
```

## 실제 기업 구현 사례

```
대기업 프록시 시스템 구조:

이중화 프록시:
┌─────────────────────────────────────────────────┐
│ 사용자 PC                                       │
│     │                                           │
│ ┌───┴────┐                                      │
│ │로드밸런서│                                     │
│ └─┬────┬─┘                                      │
│   │    │                                        │
│ 프록시A 프록시B                                  │
│   │    │                                        │
│   └────┼─────→ 인터넷                           │
│        │                                        │
│    장애 대응                                     │
└─────────────────────────────────────────────────┘

통합 보안 관제:
┌─────────────────────────────────────────────────┐
│ SIEM (Security Information Event Management):   │
│                                                 │
│ • 프록시 로그 수집                              │
│ • IPS 이벤트 연동                              │
│ • 사용자 행위 분석                              │
│ • 위협 상관관계 분석                            │
│                                                 │
│ 대시보드:                                       │
│ • 실시간 트래픽 현황                            │
│ • 차단된 위협 통계                              │
│ • 사용자별 활동 요약                            │
│ • 정책 위반 현황                                │
└─────────────────────────────────────────────────┘

클라우드 기반 프록시:
┌─────────────────────────────────────────────────┐
│ Zscaler, Cisco Umbrella 등:                    │
│                                                 │
│ 장점:                                           │
│ • 글로벌 PoP 활용                              │
│ • 클라우드 스케일링                             │
│ • 최신 위협 DB 자동 업데이트                   │
│ • 재택근무 지원                                 │
│                                                 │
│ 구조:                                           │
│ 사무실/재택 ──→ 클라우드 프록시 ──→ 인터넷      │
│                                                 │
│ 특징:                                           │
│ • 위치 무관 정책 적용                           │
│ • 중앙 집중식 관리                              │
│ • AI/ML 기반 위협 탐지                         │
└─────────────────────────────────────────────────┘
```

이러한 **기업 환경의 프록시 시스템**을 통해 **조직은 보안을 강화하고 내부 활동을 모니터링**할 수 있지만, 동시에 **직원 프라이버시와 업무 효율성 간의 균형**을 고려해야 합니다.