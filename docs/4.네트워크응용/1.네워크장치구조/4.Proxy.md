# Proxy 구조(우회)

## Proxy 서버의 기본 구조

```
             
            Private 192.168.0.1
            Global 3.3.3.3  
192.168.0.10    NAT Gateway                              10.10.10.20
             PC ──→ 라우터  ──→ 인터넷 ------ 라우터 ------ 웹서버    
                │                 │                        │
                │                 │ 70.70.70.70            │
                │                 │──→ 프록시                │   TCP Connection #2
                │                 │                        │
                └─────────────── 프록시 ─────────────────────┘
                    TCP       50.50.50.50                                          
                   Connection #1
```

**프록시는 보통 프록시 서버라고 말하고 항상 소켓 + 스트림 수준의 데이터를 처리**한다. **만약 내 개인 컴퓨터로 미국에 있는 어떤 서버에 접속한다고 한다면 그냥 바로 인터넷을 통해 미국에 있는 웹서버에 접속하면 된다. 이렇게 직접 접속하게 되면 웹서버 입장에서 한국에 있는 192.168.0.10이 나한테 접속을 했구나 라고 할 수 있다. 근데 이때 나라는 존재를 웹서버가 인식하지 못하게 하고 싶다**.

**그럴 때 사용할 수 있는 것이 어떤 프록시 서버라는 것을 이용하면 된다. 브라우저 설정에 보면 프록시 서버 설정이 존재한다**. **예를 들어 만약에 50.50.50.50이 IP가 속한 지리적 위치가 실제 독일이라면 내가 프록시 서버를 통해서 미국의 웹서버에 접속하게 되면 웹서버 입장에서 출발지 IP가 50.50.50.50인 독일이 된다**.

```
프록시를 통한 IP 우회:

직접 접속:
┌─────────────────────────────────────────────────┐
│ 한국 PC (192.168.0.10) ──→ 미국 웹서버         │
│                                                 │
│ 웹서버가 보는 접속자: 한국 IP                   │
│ 지리적 위치: 한국                               │
│ ISP 추적: 가능                                  │
└─────────────────────────────────────────────────┘

프록시 경유 접속:
┌─────────────────────────────────────────────────┐
│ 한국 PC ──→ 독일 프록시 ──→ 미국 웹서버        │
│                                                 │
│ 웹서버가 보는 접속자: 독일 프록시 IP            │
│ 지리적 위치: 독일                               │
│ 실제 사용자: 한국 (서버는 모름)                 │
└─────────────────────────────────────────────────┘

브라우저 프록시 설정:
┌─────────────────────────────────────────────────┐
│ HTTP 프록시: 50.50.50.50:8080                  │
│ HTTPS 프록시: 50.50.50.50:8443                 │
│ SOCKS 프록시: 50.50.50.50:1080                 │
│                                                 │
│ 예외 사이트: localhost, *.company.com           │
│ 자동 구성: PAC 파일 사용                        │
└─────────────────────────────────────────────────┘
```

그래서 **내 컴퓨터는 가만히 한 곳에 있는데 미국의 웹서버 입장에서는 출발지 IP가 프록시 IP의 실제 위치에 따라 독일, 영국이 될 수 있는 것**이다.

## 프록시 사용 목적

**이렇게 프록시를 이용해서 서버에 접근하는 가장 큰 이유는 자신을 속이기 위해서**이다. **예를 들어 ISP에서 미국쪽 접근을 완전히 차단하고 있는데 나는 반드시 미국쪽 주소에 접근이 필요할 때 프록시 서버를 변경함으로써 직접 접속하는 것이 아니라 프록시 서버를 경유하게 됨으로써 가능하게 된다**.

**당연히 직접 접속보다 한 번 돌아서 접근하기 때문에 직접 접속하는 것보다 속도가 느릴 수 있다**.

그래서 **프록시 서버를 보통 대리자, 대리인의 역할을 하는 것**이다.

```
프록시 사용 사례:

우회 접속:
┌─────────────────────────────────────────────────┐
│ 차단된 사이트 접근:                             │
│ • 지역 제한 콘텐츠 (Netflix, YouTube)           │
│ • 정부 검열 우회                                │
│ • 기업 방화벽 우회                              │
│                                                 │
│ 예시: 중국에서 구글 접속                        │
│ 중국 PC ──→ 홍콩 프록시 ──→ 구글               │
└─────────────────────────────────────────────────┘

익명성 보장:
┌─────────────────────────────────────────────────┐
│ 개인정보 보호:                                  │
│ • 실제 IP 주소 숨김                            │
│ • 웹사이트 추적 방지                            │
│ • 광고 타겟팅 방지                              │
│                                                 │
│ 보안 강화:                                      │
│ • 공용 WiFi에서 안전한 접속                     │
│ • 정부 감시 회피                                │
│ • 기업 스파이 방지                              │
└─────────────────────────────────────────────────┘

성능 최적화:
┌─────────────────────────────────────────────────┐
│ 캐싱:                                           │
│ • 자주 방문하는 사이트 캐시                      │
│ • 대역폭 절약                                   │
│ • 로딩 속도 향상                                │
│                                                 │
│ 압축:                                           │
│ • 데이터 압축으로 전송량 감소                   │
│ • 느린 네트워크에서 유용                        │
└─────────────────────────────────────────────────┘

기업 정책:
┌─────────────────────────────────────────────────┐
│ 접근 제어:                                      │
│ • 특정 사이트 차단                              │
│ • 업무 시간 제한                                │
│ • 대역폭 관리                                   │
│                                                 │
│ 모니터링:                                       │
│ • 직원 인터넷 사용 기록                         │
│ • 보안 정책 준수                                │
│ • 데이터 유출 방지                              │
└─────────────────────────────────────────────────┘
```

## 프록시 서버 내부 구조

```
                         Process                      
                                             
User Mode           소켓(Listen)   소켓(Client)                                                       
─────────────────────────────────────────────────────────────
Kernel Mode    ┌──────────────────────┐       
               │        TCP           │                  
               └──────────────────────┘       
               ┌────────────────────────┐     
               │        IP              │   70.70.70.70            
               └────────────────────────┘    
                                              
               ┌──────────────────────────┐             
               │       Driver             │             
S/W            └──────────────────────────┘                                                                                                  
─────────────────────────────────────────────────────────────
H/W                      NIC
```

**프록시 서버는 보통 2개의 소켓을 열어두고 하나는 접속을 받기 위한 소켓, 그래서 어떤 사용자가 외국의 어떤 사이트에 접속을 요청하면 그 요청을 듣고 내부적으로 클라이언트 역할을 하는 소켓을 열어서 해당 사이트에 접속을 시도한다**.

**이때 프록시 서버가 원 접속자의 정보를 서버에 알려주지 않는다면 미국 쪽 서버에서는 원래 누가 접속하려고 했는지 인지할 수 없다**.

```
프록시 서버 소켓 구조:

듀얼 소켓 아키텍처:
┌─────────────────────────────────────────────────┐
│ 프록시 서버 (50.50.50.50)                       │
│                                                 │
│ ┌─────────────┐     ┌─────────────┐             │
│ │Server Socket│     │Client Socket│             │
│ │  (Listen)   │     │ (Connect)   │             │
│ │   :8080     │     │   →외부서버  │             │
│ └─────────────┘     └─────────────┘             │
│        ↑                   ↓                   │
│   클라이언트 요청      실제 서버 요청             │
│      수신               전달                    │
└─────────────────────────────────────────────────┘

연결 흐름:
┌─────────────────────────────────────────────────┐
│ 1. 클라이언트 ──→ 프록시 (Server Socket)        │
│ 2. 프록시 파싱 ──→ 목적지 확인                  │
│ 3. 프록시 ──→ 실제 서버 (Client Socket)        │
│ 4. 서버 응답 ──→ 프록시                        │
│ 5. 프록시 ──→ 클라이언트 (응답 전달)            │
└─────────────────────────────────────────────────┘
```

## 프록시 유형별 특성

```
Forward Proxy (포워드 프록시):
┌─────────────────────────────────────────────────┐
│ 클라이언트 ──→ Forward Proxy ──→ 인터넷         │
│                                                 │
│ 용도:                                           │
│ • 기업 내부 직원들의 인터넷 접속 제어           │
│ • 캐싱을 통한 성능 향상                         │
│ • 접속 로그 및 모니터링                         │
│ • 악성 사이트 차단                              │
│                                                 │
│ 특징:                                           │
│ • 클라이언트가 프록시 설정 필요                 │
│ • 서버는 프록시 존재 인식 못함                  │
│ • 기업 환경에서 주로 사용                       │
└─────────────────────────────────────────────────┘

Reverse Proxy (리버스 프록시):
┌─────────────────────────────────────────────────┐
│ 인터넷 ──→ Reverse Proxy ──→ 내부 서버          │
│                                                 │
│ 용도:                                           │
│ • 웹서버 보호 (실제 서버 IP 숨김)               │
│ • 로드 밸런싱 (여러 서버로 분산)                │
│ • SSL 터미네이션                               │
│ • 캐싱 및 압축                                  │
│                                                 │
│ 특징:                                           │
│ • 클라이언트는 프록시 존재 모름                 │
│ • 서버 대신 요청 처리                           │
│ • 웹서비스 환경에서 주로 사용                   │
│                                                 │
│ 예시: Nginx, Apache HTTP Server                │
└─────────────────────────────────────────────────┘

Transparent Proxy (투명 프록시):
┌─────────────────────────────────────────────────┐
│ 클라이언트 ──→ 투명 프록시 ──→ 인터넷           │
│                                                 │
│ 특징:                                           │
│ • 클라이언트 설정 불필요                        │
│ • 네트워크 레벨에서 자동 리다이렉트             │
│ • 사용자가 프록시 존재 인식 못함                │
│                                                 │
│ 구현:                                           │
│ • 라우터/방화벽에서 트래픽 가로채기             │
│ • iptables REDIRECT 규칙                       │
│ • 브릿지 모드 프록시                            │
│                                                 │
│ 용도:                                           │
│ • ISP 레벨 캐싱                                │
│ • 기업 정책 강제 적용                           │
│ • 트래픽 분석 및 모니터링                       │
└─────────────────────────────────────────────────┘
```

이러한 **프록시 구조**를 이해하면 **네트워크 보안, 접근 제어, 성능 최적화, 그리고 개인정보 보호** 등 다양한 목적에 따라 **적절한 프록시 솔루션을 선택하고 구현**할 수 있습니다.