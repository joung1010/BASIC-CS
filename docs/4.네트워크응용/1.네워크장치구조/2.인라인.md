### 인라인 구조

# 네트워크 장치 구조와 패킷 흐름

## 실제 네트워크 구조 예시

```
                        공유기(Inline)                                < Inline        >
 PC       -------  NAT Gateway(L3-L4)        ------ Internet ------  라우터(Inline) ---- 방화벽(패킷 필터링 방화벽)      
 (192.168.0.10)     Private IP 192.168.0.1                              │
                    Global IP 3.3.3.3                                   │
                                                                      SSL Accelerator ------ WAF  -----   │     ------ Web Server
                                                                       IP 5.5.5.5            10.10.10.10                  10.10.10.20
```

## 패킷과 네트워크의 비유

**패킷을 설명할 때 택배, 자동차라고 생각하면 이해하기 쉽다. 만약 패킷을 자동차라고 생각하면 네트워크는 고속도로**이다. **그 자동차를 운전하다 보면 고속도로에 진입할 때 톨게이트라고 해서 돈을 내고 지나가는 게이트를 통과해서 지나가야 한다. 그리고 운전을 하다 보면 과속 감지 카메라도 존재한다. 그래서 과속감시 카메라를 통과해서 지나가지는 않는다. 카메라는 길 밖에 존재**한다.

**Inline 구조라는 것은 패킷이 통과해서 지나간다**.

```
네트워크 비유:

고속도로 시스템:
┌─────────────────────────────────────────────────┐
│ 자동차 = 패킷                                   │
│ 고속도로 = 네트워크 인프라                       │
│ 톨게이트 = Inline 장치 (라우터, 방화벽)          │
│ 과속카메라 = Out of Path 장치 (모니터링)         │
│ 휴게소 = 프록시 (중간 처리)                     │
└─────────────────────────────────────────────────┘

패킷 흐름과 장치 역할:
┌─────────────────────────────────────────────────┐
│ 출발지 ──→ [톨게이트] ──→ [과속카메라] ──→ 목적지 │
│             │               │               │
│         패킷 검사         모니터링        최종 전달
│         허용/차단         읽기 전용       
│         경로 결정         위반 탐지       
└─────────────────────────────────────────────────┘

실제 네트워크 매핑:
┌─────────────────────────────────────────────────┐
│ PC ──→ [공유기] ──→ [IDS] ──→ [웹서버]           │
│         │           │          │               │
│      NAT 처리     침입 탐지   서비스 제공        │
│      주소 변환    패턴 분석   콘텐츠 응답        │
└─────────────────────────────────────────────────┘
```

## Inline 장치의 특성

**Inline 디바이스는 흔히 집에서 공유기가 전형적인 Inline 디바이스가 있다. 또한 라우터가 있다. 방화벽 중에서 패킷 필터링 방화벽이 Inline 형태로 작동하는 스위치**이다.

그래서 **Inline이라는 단어가 나오면 패킷(MTU)이라는 단어를 기억하자. Inline이기 때문에 패킷이 Bypass 되거나 Drop 된다**.

**위 도식도는 어떠한 개인 PC가 Inline 디바이스인 공유기를 거쳐서 웹서버에 도착하는 것을 그린 것**이다.

```
Inline 장치 특징:

물리적 배치:
┌─────────────────────────────────────────────────┐
│ 입력 포트 ──→ [처리 엔진] ──→ 출력 포트          │
│               │                                 │
│            패킷 분석                            │
│            정책 적용                            │
│            경로 결정                            │
└─────────────────────────────────────────────────┘

처리 방식:
┌─────────────────────────────────────────────────┐
│ 1. 패킷 수신                                    │
│ 2. 헤더 분석 (L2-L4)                           │
│ 3. 정책 매칭                                    │
│ 4. 액션 결정:                                   │
│    • Forward (전달)                            │
│    • Drop (폐기)                               │
│    • Modify (수정)                             │
│ 5. 다음 홉으로 전송                             │
└─────────────────────────────────────────────────┘

대표 장치:
┌─────────────────────────────────────────────────┐
│ • 공유기: NAT, DHCP, 무선 기능                  │
│ • 라우터: IP 라우팅, OSPF, BGP                 │
│ • L3 스위치: VLAN, STP, 라우팅                 │
│ • 패킷 필터링 방화벽: ACL, 상태 추적            │
│ • 로드밸런서: 트래픽 분산, 헬스 체크            │
└─────────────────────────────────────────────────┘
```

## Inbound vs Outbound 트래픽

```
                  ← Inbound 
PC ----- L2 Switch ----- Distribution Switch ---- Router │ ----- Internet ------
        → Outbound
```

**라우터를 통해 인터넷을 나가는 기준으로 라우터 안쪽을 내부이고 인터넷 쪽을 외부**라고 한다. **이때 트래픽이 인터넷 밖으로 나가는 것을 Outbound**라고 한다. **반대로 인터넷에서 라우터 안쪽으로 들어오는 것은 Inbound**라고 한다.

```
트래픽 방향성:

Outbound (외부로 나가는 트래픽):
┌─────────────────────────────────────────────────┐
│ 사용 사례:                                      │
│ • 웹 사이트 접속                                │
│ • 이메일 전송                                   │
│ • 파일 다운로드                                 │
│ • API 호출                                     │
│                                                 │
│ 보안 정책:                                      │
│ • URL 필터링                                   │
│ • 애플리케이션 제어                             │
│ • 대역폭 제한                                   │
│ • 악성코드 차단                                 │
└─────────────────────────────────────────────────┘

Inbound (내부로 들어오는 트래픽):
┌─────────────────────────────────────────────────┐
│ 사용 사례:                                      │
│ • 웹서버 접속                                   │
│ • 원격 접속 (SSH, RDP)                         │
│ • 이메일 수신                                   │
│ • VPN 연결                                     │
│                                                 │
│ 보안 정책:                                      │
│ • 포트 제한                                     │
│ • 접근 제어 목록 (ACL)                         │
│ • DDoS 방어                                    │
│ • 침입 방지                                     │
└─────────────────────────────────────────────────┘

실제 정책 적용:
┌─────────────────────────────────────────────────┐
│ 기업 환경 예시:                                 │
│                                                 │
│ Outbound 정책:                                  │
│ • 업무 시간에만 YouTube 허용                    │
│ • P2P 트래픽 차단                              │
│ • 개인 이메일 제한                              │
│                                                 │
│ Inbound 정책:                                   │
│ • 웹서버 포트(80, 443)만 허용                   │
│ • 관리자 IP에서만 SSH 접근                      │
│ • VPN 사용자만 내부 리소스 접근                 │
└─────────────────────────────────────────────────┘
```

## 라우터의 내부 구조

```
              Process
                                     
User Mode                          
─────────────────────────────────────────────────────────────
Kernel Mode    ┌────────────────────────────────────────┐             
               │                TCP                     │             
               └────────────────────────────────────────┘             
               ┌────────────────────────────────────────┐             
               │                IP                      │             
               └────────────────────────────────────────┘ 

               ┌────────────────────────────────────────┐             
               │              Inline                    │             
               └────────────────────────────────────────┘
                           
S/W            Driver                                  Driver              
─────────────────────────────────────────────────────────────
H/W            NIC A                                    NIC B  ------ 인터넷
```

그러면 **라우터는 어떻게 생겼을까? 라우터도 내부적으로 보면 그냥 작은 컴퓨터**이다. **쉽게 생각해서 랜카드가 여러 개 달려있는 컴퓨터라고 생각하면 된다**. 그러면 **이때 유입되는 최초의 데이터는 Frame 형태이고 일반적으로는 이 프레임 형태의 데이터가 위로 TCP/IP를 거쳐 프로세스로 올라가는 형태였겠지만 Inline 디바이스는 데이터가 안으로 들어오는 것뿐만 아니라 외부로 나가야 할 데이터 또한 존재**한다.

그래서 **보통 Outbound일 때 A NIC를 타고 들어와서 Inline을 거쳐서 B NIC를 통해서 인터넷 외부로 나가고 반대로 인터넷에서 B를 통해서 들어와 Inline을 거쳐서 A를 통해 나가면 Inbound가 된다**.

`라우터 내부 패킷 흐름:

하드웨어 레벨:
┌─────────────────────────────────────────────────┐
│ NIC A ────→ [패킷 버퍼] ────→ NIC B              │
│  ↑              │               ↓               │
│ 수신           처리 엔진        전송              │
│              ┌─────────┐                         │
│              │라우팅   │                         │
│              │테이블   │                         │
│              │조회     │                         │
│              └─────────┘                         │
└─────────────────────────────────────────────────┘

소프트웨어 레벨:
┌─────────────────────────────────────────────────┐
│ 1. 프레임 수신 (L2)                             │
│ 2. 이더넷 헤더 제거                             │
│ 3. IP 패킷 추출 (L3)                           │
│ 4. 라우팅 테이블 조회                           │
│ 5. 다음 홉 결정                                │
│ 6. 새로운 이더넷 헤더 추가                      │
│ 7. 출력 인터페이스로 전송                       │
└─────────────────────────────────────────────────┘

멀티 인터페이스 라우터:
┌─────────────────────────────────────────────────┐
│            [Central Processing Unit]             │
│                      │                         │
│ ┌─────────┬─────────┼─────────┬─────────┐      │
│ │ Port 1  │ Port 2  │ Port 3  │ Port 4  │      │
│ │LAN      │WAN      │DMZ      │WiFi     │      │
│ │.1 대역  │인터넷   │서버 구간│무선     │      │
│ └─────────┴─────────┴─────────┴─────────┘      │
│                                                 │
│ 각 포트별 독립적 서브넷 관리                     │
│ 포트 간 라우팅 및 NAT 처리                      │
└─────────────────────────────────────────────────┘`

## 커널 모드 vs 유저 모드 처리

그러면 **여기서 한 가지 의문이 든다. 이 Inline을 커널 모드가 아니라 유저 모드에서 구현하면 안 되는 것일까?? 물론 안 되는 것은 아니지만 유저 모드에서 구현하는 것과 커널 모드에서 작동하는 것을 보면 딱 봐도 커널 모드에서 동작하는 것이 좀 더 짧다. 또한 커널 모드에서의 입출력 속도가 압도적으로 빠르기 때문**도 있다.

```
커널 모드 vs 유저 모드 비교:

커널 모드 처리:
┌─────────────────────────────────────────────────┐
│ 장점:                                           │
│ • 직접적 하드웨어 접근                          │
│ • 시스템 콜 오버헤드 없음                       │
│ • 인터럽트 처리 가능                            │
│ • 메모리 복사 최소화                            │
│ • 높은 처리 성능                                │
│                                                 │
│ 단점:                                           │
│ • 개발 복잡도 높음                              │
│ • 디버깅 어려움                                 │
│ • 시스템 안정성 위험                            │
│ • 업데이트 어려움                               │
└─────────────────────────────────────────────────┘

유저 모드 처리:
┌─────────────────────────────────────────────────┐
│ 장점:                                           │
│ • 안전한 메모리 공간                            │
│ • 디버깅 용이                                   │
│ • 개발 생산성 높음                              │
│ • 업데이트 간편                                 │
│ • 다양한 라이브러리 활용                        │
│                                                 │
│ 단점:                                           │
│ • 시스템 콜 오버헤드                            │
│ • 메모리 복사 비용                              │
│ • 컨텍스트 스위칭 지연                          │
│ • 상대적으로 낮은 성능                          │
└─────────────────────────────────────────────────┘

성능 비교 (예시):
┌─────────────────────────────────────────────────┐
│ 커널 모드: 10Gbps 라인 레이트 처리 가능          │
│ 유저 모드: 1-5Gbps 정도 처리 (최적화에 따라)    │
│                                                 │
│ 지연 시간:                                      │
│ 커널 모드: 마이크로초 단위                       │
│ 유저 모드: 밀리초 단위                          │
└─────────────────────────────────────────────────┘
```

## Throughput과 성능 최적화

그래서 **Inline 디바이스는 Throughput 처리율이라는 말을 한다. 무언가가 통과해서 지나가는 곳이다 보니 투과율이 얼마나 좋으냐에 따라서 그 성능이 달라진다**.

**아무리 네트워크 속도가 빠르더라도 이 Inline 디바이스의 속도가 낮거나 저하되면 전체적인 네트워크 속도가 느려진다**. 그래서 **최대한 할 수만 있다면 하드웨어 수준에서 데이터가 들어오고 나가고, 즉 바로바로 처리가 가능하다면 가장 좋다. 하지만 어떤 튜닝이나 수정이 발생하면 하드웨어 수준에서의 변화가 필요하기 때문에 하드웨어와 소프트웨어의 어느 정도 절충안을 찾아서 구현되는 게 일반적**이다.

```
네트워크 처리 성능 계층:

하드웨어 처리 (ASIC):
┌─────────────────────────────────────────────────┐
│ 성능: 매우 높음 (테라비트 급)                    │
│ 지연: 나노초 단위                               │
│ 유연성: 매우 낮음                               │
│ 비용: 높음                                      │
│                                                 │
│ 적용 분야:                                      │
│ • 코어 라우터/스위치                            │
│ • 고성능 방화벽                                 │
│ • 전용 네트워크 장비                            │
└─────────────────────────────────────────────────┘

FPGA (Field Programmable Gate Array):
┌─────────────────────────────────────────────────┐
│ 성능: 높음 (기가비트 급)                        │
│ 지연: 마이크로초 단위                           │
│ 유연성: 중간                                    │
│ 비용: 중간                                      │
│                                                 │
│ 적용 분야:                                      │
│ • 프로그래밍 가능한 네트워크 장비               │
│ • 특수 목적 처리기                              │
│ • 프로토타입 개발                               │
└─────────────────────────────────────────────────┘

소프트웨어 처리 (x86):
┌─────────────────────────────────────────────────┐
│ 성능: 중간 (메가비트~기가비트)                   │
│ 지연: 밀리초 단위                               │
│ 유연성: 매우 높음                               │
│ 비용: 낮음                                      │
│                                                 │
│ 적용 분야:                                      │
│ • 소프트웨어 정의 네트워킹 (SDN)                │
│ • 가상화 환경                                   │
│ • 클라우드 네트워크                             │
└─────────────────────────────────────────────────┘

하이브리드 접근법:
┌─────────────────────────────────────────────────┐
│ 빠른 경로 (Fast Path):                          │
│ • 하드웨어에서 단순한 패킷 포워딩               │
│ • 라우팅 테이블 룩업                            │
│ • 기본적인 ACL 처리                            │
│                                                 │
│ 느린 경로 (Slow Path):                          │
│ • 소프트웨어에서 복잡한 처리                    │
│ • 새로운 플로우 설정                            │
│ • 예외 상황 처리                                │
│ • 관리 및 설정                                  │
└─────────────────────────────────────────────────┘

성능 최적화 기법:
┌─────────────────────────────────────────────────┐
│ • 패킷 배칭: 여러 패킷을 묶어서 처리            │
│ • 제로 카피: 메모리 복사 최소화                  │
│ • 폴링 모드: 인터럽트 대신 지속적 확인          │
│ • CPU 바인딩: 특정 코어에 작업 고정             │
│ • NUMA 최적화: 메모리 지역성 고려               │
│ • SR-IOV: 가상화 환경에서 하드웨어 직접 접근    │
└─────────────────────────────────────────────────┘

실제 제품 예시:
┌─────────────────────────────────────────────────┐
│ Cisco ASR 시리즈: 하드웨어 + 소프트웨어 결합    │
│ • 데이터 플레인: 전용 ASIC                     │
│ • 컨트롤 플레인: 리눅스 기반 소프트웨어        │
│                                                 │
│ Juniper MX 시리즈: 유사한 하이브리드 구조       │
│ • Packet Forwarding Engine (PFE): 하드웨어    │
│ • Routing Engine (RE): 소프트웨어              │
└─────────────────────────────────────────────────┘
```

이러한 **Inline 장치의 구조와 성능 특성**을 이해하면 **네트워크 설계 시 적절한 장비 선택과 배치 전략을 수립**할 수 있고, **전체 네트워크의 성능 병목점을 파악하고 최적화**할 수 있습니다.