## 세 가지 네트워크 장치 구조

**네트워크는 3가지 장치로 구분된다. Inline, Out of Path, Proxy 이 3가지로 구성**된다.

- **Inline**: Packet + Drop/Bypass + Filtering
- **Out of Path**: Packet + Read only + Sensor
- **Proxy**: Socket Stream + Filtering

이 **Inline과 Out of Path는 둘 다 패킷 데이터를 다룬다. 그리고 나머지 Proxy는 Socket 스트림 데이터를 다룬다**.

**네트워크에서 주로 스위치나 혹은 스위치 역할을 하는 것에 대해서 공부하거나 봤을 때**

**만약 처음 보는 네트워크 장치를 만나게 되었다면 위 3가지 중에서 어떤 구조로 되어 있는지 혹은 전부 포함하는 구조인지를 파악해야 한다**.

```
네트워크 장치 분류 기준:

데이터 처리 레벨:
┌─────────────────────────────────────────────────┐
│ Packet Level (L2-L3):                          │
│ • Inline, Out of Path                          │
│ • 하드웨어 기반 고속 처리                       │
│ • 단순한 헤더 정보 분석                         │
│                                                 │
│ Stream Level (L5-L7):                          │
│ • Proxy                                        │
│ • 소프트웨어 기반 처리                          │
│ • 애플리케이션 데이터 분석                      │
└─────────────────────────────────────────────────┘

처리 방식:
┌─────────────────────────────────────────────────┐
│ 능동적 처리 (Active):                           │
│ • Inline, Proxy                                │
│ • 트래픽 제어 가능                              │
│ • 필터링/차단 기능                              │
│                                                 │
│ 수동적 처리 (Passive):                          │
│ • Out of Path                                  │
│ • 모니터링/분석 전용                            │
│ • 트래픽에 영향 없음                            │
└─────────────────────────────────────────────────┘
```

## 1. Inline 구조

이 **Inline은 구조적으로 필터링이 가능하다. 공기청정기 필터처럼 생겼다**. 그래서 이 **패킷 데이터가 Inline 디바이스를 통과해서 지나간다**. 근데 **그 통과하는 데이터를 그냥 통과시킬지(Bypass) 혹은 통과시키지 못하게 할지(Drop), 데이터의 통과 및 차단을 수행**한다. **만약 Bypass 시에 그 통과할 수 있는 다음 경로(Path)가 여러 개 있다면 그중 어떤 경로로 가야 할지 선택**한다. 그래서 **이 Inline 디바이스를 설명하는 가장 대표적인 장치가 라우터**이다.

```
Inline 구조 상세도:

입력 ──→ [Inline Device] ──→ 출력
         │               │
         ├─ 패킷 분석     │
         ├─ 정책 적용     │
         ├─ 필터링       │
         └─ 경로 결정     │
                        │
            ┌───────────┴───────────┐
            │                       │
         Drop/Block              Bypass/Forward
            │                       │
         패킷 폐기              ┌─────┴─────┐
                               │           │
                           경로 A      경로 B

대표 장치:
┌─────────────────────────────────────────────────┐
│ 라우터 (Router):                                │
│ • IP 기반 경로 결정                             │
│ • 라우팅 테이블 참조                            │
│ • 패킷 포워딩                                   │
│                                                 │
│ 방화벽 (Firewall):                              │
│ • 보안 정책 기반 필터링                         │
│ • 패킷 허용/차단 결정                           │
│ • NAT, VPN 기능                                │
│                                                 │
│ 로드밸런서 (Load Balancer):                     │
│ • 트래픽 분산 처리                              │
│ • 서버 상태 확인                                │
│ • 세션 지속성 관리                              │
│                                                 │
│ IPS (Intrusion Prevention System):             │
│ • 실시간 위협 탐지 및 차단                      │
│ • 패킷 검사 및 분석                             │
│ • 공격 패턴 매칭                                │
└─────────────────────────────────────────────────┘

처리 과정:
┌─────────────────────────────────────────────────┐
│ 1. 패킷 수신                                    │
│ 2. 헤더 분석 (IP, TCP/UDP)                     │
│ 3. 정책/규칙 매칭                               │
│ 4. 액션 결정 (Drop/Bypass/Forward)             │
│ 5. 패킷 처리 (수정/전달/폐기)                   │
│ 6. 로깅 및 통계                                │
└─────────────────────────────────────────────────┘
```

## 2. Out of Path 구조

**Out of Path는 Inline처럼 패킷 데이터를 다루는 것은 동일하나 데이터의 허용과 차단이 아니라 단순히 보기만 한다(Read only)**. 그래서 **이 장치의 주된 목적은 어떤 뭔가를 인지(Sensor) 하는 것을 가장 큰 목표**로 한다. 그래서 **만약에 네트워크상에 보안상의 이슈를 인지하겠다 하면 보안 센서가 되는 것이고 네트워크 장애를 인지하겠다 하면 장애 대응 센서가 되는 것**이다.

**추가적으로 TAP 스위치라고 하는 것을 통해서 패킷을 복사해서 그 복사된 패킷을 가지고 읽어서 분석하고 알려준다**. 그래서 **이러한 장치들을 연결하는 포인트를 TAP핑 포인트**라고 한다. 그래서 **이 TAP핑 포인트에 연결되는 장치들이 주로 Out of Path 구조를 가진다**.

```
Out of Path 구조 상세도:

실제 네트워크 경로:
송신자 ──→ 스위치 ──→ 라우터 ──→ 수신자
            │
            │ (미러링/복사)
            ▼
       [TAP/Mirror Port]
            │
            ▼
    [Out of Path Device]
            │
            ▼
     분석/모니터링/알림

TAP(Test Access Point) 구조:
┌─────────────────────────────────────────────────┐
│                                                 │
│ 원본 트래픽 ────┬──→ 목적지                     │
│                 │                               │
│                 └──→ TAP ──→ 분석 장비          │
│                      │                         │
│                 트래픽 복사                     │
│                 (원본 무손실)                   │
└─────────────────────────────────────────────────┘

대표 장치:
┌─────────────────────────────────────────────────┐
│ IDS (Intrusion Detection System):              │
│ • 네트워크 트래픽 모니터링                      │
│ • 공격 패턴 탐지                                │
│ • 보안 이벤트 알림                              │
│ • 실시간 위협 분석                              │
│                                                 │
│ 네트워크 모니터링 시스템:                       │
│ • 대역폭 사용량 측정                            │
│ • 트래픽 패턴 분석                              │
│ • 성능 지표 수집                                │
│ • 장애 예측 및 알림                             │
│                                                 │
│ 패킷 캡처 시스템:                               │
│ • Wireshark, tcpdump                           │
│ • 포렌식 분석                                   │
│ • 트러블슈팅                                    │
│                                                 │
│ DLP (Data Loss Prevention):                    │
│ • 데이터 유출 탐지                              │
│ • 정책 위반 모니터링                            │
│ • 컴플라이언스 감사                             │
└─────────────────────────────────────────────────┘

TAP 방식:
┌─────────────────────────────────────────────────┐
│ 물리적 TAP:                                     │
│ • 케이블 중간에 물리적 분기                      │
│ • 100% 트래픽 복사                             │
│ • 지연 시간 최소                                │
│                                                 │
│ 스위치 포트 미러링:                             │
│ • SPAN Port (Cisco)                            │
│ • Mirror Port (일반)                           │
│ • 설정으로 트래픽 복사                          │
│                                                 │
│ 가상 TAP:                                       │
│ • 소프트웨어 기반                               │
│ • VM 환경에서 트래픽 복사                       │
│ • 클라우드 환경 지원                            │
└─────────────────────────────────────────────────┘
```

## 3. Proxy 구조

**Proxy는 앞서 둘과는 다루는 데이터 자체가 다르다. 패킷 수준이 아니라 소켓 스트림 수준에서 처리를 하다 보니 스트림 데이터를 볼 수 있다는 장점이 있다**. **이것이 왜 장점인가 하면 패킷 수준에서 스트림 데이터를 확인해보려면 이 패킷들을 전부 조립해야 되는데 상당히 어려운 작업**이다. 그래서 **보통 MP3, JPG, DOC와 같은 파일 수준의 유저 모드 애플리케이션 데이터를 다루면 그때는 Proxy 구조를 쓸 수밖에 없다**.

근데 **이 Proxy는 구성면에서 Inline과 비슷하다. 바로 필터링이 가능하다. 즉 통과해서 지나갈 수 있냐 없냐 하는 것**이다. **이 Proxy에는 Read only 개념이 없다. 어떤 대리자로써 이 대리자를 통해 데이터가 지나가기 때문에 Proxy 입장에서 애플리케이션 스트림 데이터를 전체 다 모니터링할 수 있다는 것이 특징**이다.

```
                Process   
                                 Proxy 
User Mode     Socket 인터페이스  ──→ 스트림 데이터                   
─────────────────────────────────────────────────────────────
Kernel Mode    ┌─────┐             
               │ TCP │             
               └─────┘             
               ┌─────┐             
               │ IP  │ ──→ Packet 수준 (MTU) Inline, Out of Path          
               └─────┘             
S/W            Driver              
─────────────────────────────────────────────────────────────
H/W            NIC
```

**이 Proxy는 주로 유저 모드에 위치해서 있어서 보통 유저 모드 애플리케이션 Proxy라 부르는데**

그래서 **Proxy를 말할 때 유저 모드 + 애플리케이션 + Proxy + 소켓 + 스트림 이렇게 통으로 기억해라**

그래서 **Proxy는 주로 L5~L7 계층을 커버**한다. **추가적으로 HTTP 프로토콜은 L7 프로토콜이다. 그러면 이 HTTP를 분석하려면 위 3구조 중에서 Proxy가 유리하다. 그러면 L3에서는 불가능할까? 불가능하지 않지만 패킷을 조립하고 다시 열고 하는 복잡한 작업을 동반**한다.

```
Proxy 구조 상세도:

클라이언트 ──→ [Proxy Server] ──→ 웹서버
              │            │
              ├─ 요청 분석  │
              ├─ 내용 검사  │
              ├─ 정책 적용  │
              ├─ 캐싱      │
              └─ 로깅      │

Proxy 처리 과정:
┌─────────────────────────────────────────────────┐
│ 1. 클라이언트 연결 수락                          │
│ 2. HTTP 요청 파싱                               │
│ 3. 정책 검사 (URL 필터링, 콘텐츠 검사)          │
│ 4. 서버 연결 설정                               │
│ 5. 요청 전달                                    │
│ 6. 응답 수신 및 분석                            │
│ 7. 콘텐츠 필터링/수정                           │
│ 8. 클라이언트에 응답 전달                       │
└─────────────────────────────────────────────────┘

대표 장치/소프트웨어:
┌─────────────────────────────────────────────────┐
│ 웹 프록시:                                      │
│ • Squid, Apache HTTP Server                    │
│ • URL 필터링, 캐싱                             │
│ • 사용자 인증                                   │
│                                                 │
│ 보안 프록시:                                    │
│ • Blue Coat, Forcepoint                        │
│ • 멀웨어 탐지                                   │
│ • 데이터 유출 방지                              │
│                                                 │
│ 리버스 프록시:                                  │
│ • Nginx, HAProxy                               │
│ • 로드 밸런싱                                   │
│ • SSL 터미네이션                               │
│                                                 │
│ API 게이트웨이:                                 │
│ • Kong, AWS API Gateway                        │
│ • API 관리 및 보안                             │
│ • 인증, 인가, 레이트 리미팅                     │
└─────────────────────────────────────────────────┘

Proxy 유형:
┌─────────────────────────────────────────────────┐
│ Forward Proxy (클라이언트 대리):                 │
│ 클라이언트 → Proxy → 인터넷                     │
│ • 인터넷 접근 제어                              │
│ • 캐싱으로 성능 향상                            │
│ • 익명성 제공                                   │
│                                                 │
│ Reverse Proxy (서버 대리):                      │
│ 인터넷 → Proxy → 서버                          │
│ • 서버 보호                                     │
│ • 로드 밸런싱                                   │
│ • SSL 오프로딩                                 │
│                                                 │
│ Transparent Proxy (투명 프록시):                │
│ • 클라이언트 설정 불필요                        │
│ • 자동 트래픽 인터셉트                          │
│ • 정책 강제 적용                                │
└─────────────────────────────────────────────────┘
```

## 계층별 데이터 처리 비교

```
패킷 vs 스트림 데이터 처리:

패킷 레벨 처리 (Inline, Out of Path):
┌─────────────────────────────────────────────────┐
│ 장점:                                           │
│ • 하드웨어 기반 고속 처리                       │
│ • 지연 시간 최소                                │
│ • 높은 처리량 (Throughput)                     │
│ • 네트워크 레벨 정보 접근                       │
│                                                 │
│ 단점:                                           │
│ • 애플리케이션 내용 분석 어려움                  │
│ • 암호화된 트래픽 분석 제한                     │
│ • 세션 재조립 복잡성                            │
└─────────────────────────────────────────────────┘

스트림 레벨 처리 (Proxy):
┌─────────────────────────────────────────────────┐
│ 장점:                                           │
│ • 애플리케이션 데이터 완전 분석                  │
│ • 콘텐츠 기반 정책 적용                         │
│ • 프로토콜별 특화 처리                          │
│ • 사용자 행위 분석 가능                         │
│                                                 │
│ 단점:                                           │
│ • 소프트웨어 기반으로 상대적 저속               │
│ • 메모리 사용량 높음                            │
│ • CPU 집약적 처리                              │
│ • 지연 시간 증가                                │
└─────────────────────────────────────────────────┘

HTTP 분석 예시:
┌─────────────────────────────────────────────────┐
│ 패킷 레벨:                                      │
│ • IP 헤더: 출발지/목적지 주소                   │
│ • TCP 헤더: 포트 번호, 시퀀스 번호              │
│ • 단편적 정보만 획득                            │
│                                                 │
│ 스트림 레벨 (Proxy):                            │
│ • HTTP 메서드 (GET, POST)                      │
│ • URL 전체 경로                                │
│ • 헤더 정보 (User-Agent, Cookie)               │
│ • 바디 내용 (파일, 폼 데이터)                   │
│ • 완전한 애플리케이션 컨텍스트                  │
└─────────────────────────────────────────────────┘
```

## 하이브리드 구조

```
복합 구조 장치:

멀티 기능 방화벽 (NGFW):
┌─────────────────────────────────────────────────┐
│ Inline 기능:                                    │
│ • 패킷 필터링                                   │
│ • 라우팅                                        │
│                                                 │
│ Out of Path 기능:                               │
│ • IDS/IPS                                      │
│ • 트래픽 분석                                   │
│                                                 │
│ Proxy 기능:                                     │
│ • 애플리케이션 제어                             │
│ • 웹 필터링                                     │
│ • SSL 인스펙션                                 │
└─────────────────────────────────────────────────┘

통합 보안 게이트웨이:
┌─────────────────────────────────────────────────┐
│ • 방화벽 + IPS + 웹필터 + 안티바이러스          │
│ • 단일 장비에서 다중 보안 기능                   │
│ • 중앙 집중식 관리                              │
│ • 성능 최적화                                   │
└─────────────────────────────────────────────────┘
```

이러한 **네트워크 장치 구조의 이해**는 **네트워크 설계, 보안 아키텍처 구성, 성능 최적화**에서 **적절한 장치 선택과 배치 전략 수립**에 필수적인 기초 지식입니다.