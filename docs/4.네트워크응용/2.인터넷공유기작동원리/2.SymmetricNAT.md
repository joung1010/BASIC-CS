# Symmetric NAT 개요

## NAT 패킷 변환 과정

```
                      Private IP 192.168.0.1
192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
  1                        2
  
  IP              │ TCP         │ Payload(data)
 Src:192.168.0.10 │  Src:3000   │               
 Dst:15.15.15.15  │  Dst:80     │
```

**NAT는 기본적으로 주소와 포트를 변환한다. 그러면 이 패킷 안에 있는 IP 주소와 Port 번호를 어떻게 변화하는지에 대해서 알아보자. 공유기 기준으로 왼편에 있는 내부 네트워크에서 사용하는 Private IP 주소라는 것은 인터넷이라는 퍼블릭 네트워크에서는 통용이 원칙적으로는 불가능한 것이다**.

**위에 보면 NAT Gateway는 인터페이스가 2개이다. 그중에서 내부망 안쪽에 할당하는 주소가 192.168.0.1이다**.

**그러면 이 PC 입장에서 192.168.0.1이 Gateway가 되는 것이다. 당연하게도 이 주소로는 인터넷을 할 수 없다**.

**이 사설 주소로 ISP의 인터넷 서비스를 이용하게 되면 Global IP 주소 혹은 Public IP 주소를 할당해준다. 이 Global IP 주소는 실제 인터넷이 사용 가능한 주소이다**.

```
NAT Gateway 인터페이스 구조:

물리적 구성:
┌─────────────────────────────────────────────────┐
│                NAT Gateway                      │
│                                                 │
│ ┌─────────────┐           ┌─────────────┐       │
│ │LAN Interface│           │WAN Interface│       │
│ │192.168.0.1  │           │  3.3.3.3    │       │
│ │(내부망)     │           │ (인터넷)    │       │
│ └─────────────┘           └─────────────┘       │
│       │                         │               │
│   내부 스위치               인터넷 연결           │
└─────────────────────────────────────────────────┘

논리적 역할:
┌─────────────────────────────────────────────────┐
│ 내부 인터페이스 (LAN):                          │
│ • 사설 IP 대역 관리                             │
│ • DHCP 서버 역할                               │
│ • 기본 게이트웨이                               │
│ • 내부 라우팅                                   │
│                                                 │
│ 외부 인터페이스 (WAN):                          │
│ • 공인 IP 주소 보유                            │
│ • 인터넷 연결                                   │
│ • ISP와 통신                                   │
│ • NAT 변환 수행                                │
└─────────────────────────────────────────────────┘

IP 주소 할당:
┌─────────────────────────────────────────────────┐
│ PC 네트워크 설정:                               │
│ • IP: 192.168.0.10                             │
│ • 서브넷 마스크: 255.255.255.0                  │
│ • 게이트웨이: 192.168.0.1                       │
│ • DNS: 8.8.8.8, 1.1.1.1                       │
│                                                 │
│ 공유기 WAN 설정:                               │
│ • IP: 3.3.3.3 (ISP에서 할당)                   │
│ • 서브넷 마스크: 255.255.255.252 (예시)         │
│ • 게이트웨이: ISP 라우터                        │
│ • DNS: ISP DNS 서버                            │
└─────────────────────────────────────────────────┘
```

## 패킷 변환 과정

**예를 들어 192.168.0.10의 Private IP를 사용하는 PC가 어떤 웹서버에 접속한다고 했을 때 DNS에서 그 웹서버의 IP 주소를 15.15.15.15라고 응답했다고 가정해보자. 먼저 TCP 연결 후에 HTTP 통신을 진행할 것이다. 그래서 이 PC에서 생성되는 최초의 패킷의 형태에서는 출발지 주소가 자신의 IP 주소를 그대로 사용할 것이다**.

```
 1단계: PC에서 생성된 원본 패킷
  IP              │ TCP         │ Payload(data)
 Src:192.168.0.10 │  Src:3000   │               
 Dst:15.15.15.15  │  Dst:80     │
```

**목적지 당연히 우리가 접속하려는 웹서버 IP 주소일 것이고 특별한 경우가 아니면 80번 포트에 연결을 시도할 것이다. 그리고 출발지 포트는 운영체제에서 가능한 포트 번호를 자동으로 할당해줄 것이다. 그래서 이 패킷이 NAT Gateway 공유기에 도착하는 순간 기본적으로 Inline 장비인데 패킷이 도착하고 외부로 내보내는 그 시점에 IP와 포트를 변환한다**.

```
                         Private IP 192.168.0.1
 192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
  1                        2
  
                                              IP              │ TCP         │ Payload(data)
                                             Src:3.3.3.3      │  Src:23000  │               
                                             Dst:15.15.15.15  │  Dst:80     │
                                             < ────── 주소와포트변경 ────────→
```

**즉 Outbound가 될 때 패킷을 변환시킨다. 출발지 주소를 해당 공유기가 가지고 있는 Global IP 주소로 변환하고 이때 출발지 포트 번호도 변환된다. 그래서 원래는 출발지 IP 주소가 192.168.0.10에서 3.3.3.3으로 변경되고 출발지 포트가 3000번에서 23000번으로 변경된다. 그래서 TCP/IP 헤더 부분이 변경된 것이다. 그래서 변경된 Global IP 주소는 인터넷에서 통용될 수 있고 이렇게 밖으로 나간 패킷이 웹서버에 도착하게 된다**.

```
NAT 변환 세부 과정:

1. 패킷 수신 및 분석:
┌─────────────────────────────────────────────────┐
│ NAT Gateway에서 수행하는 작업:                   │
│                                                 │
│ 1. 내부 인터페이스로 패킷 수신                   │
│ 2. IP 헤더 분석:                               │
│    • 출발지: 192.168.0.10 (내부망)             │
│    • 목적지: 15.15.15.15 (인터넷)              │
│ 3. TCP 헤더 분석:                              │
│    • 출발지 포트: 3000                         │
│    • 목적지 포트: 80                           │
│ 4. 라우팅 테이블 확인: 외부로 전송 필요         │
│ 5. NAT 변환 수행                               │
└─────────────────────────────────────────────────┘

2. 포트 할당 알고리즘:
┌─────────────────────────────────────────────────┐
│ Symmetric NAT 포트 할당:                        │
│                                                 │
│ 사용 가능한 포트 범위: 20000-30000              │
│ 할당 방식: 순차적 또는 랜덤                     │
│                                                 │
│ 고려사항:                                       │
│ • 기존 사용 중인 포트 확인                      │
│ • 동일 내부 호스트의 다른 연결과 구분           │
│ • 목적지별 고유 포트 할당 (Symmetric의 특징)    │
│                                                 │
│ 예시:                                           │
│ 192.168.0.10 → 서버A: 포트 23000 할당          │
│ 192.168.0.10 → 서버B: 포트 23001 할당          │
│ 192.168.0.11 → 서버A: 포트 23002 할당          │
└─────────────────────────────────────────────────┘

3. 헤더 재작성:
┌─────────────────────────────────────────────────┐
│ 원본 IP 헤더:                                   │
│ Version=4, IHL=5, ToS=0, Length=40              │
│ ID=12345, Flags=2, Fragment=0                   │
│ TTL=64, Protocol=6, Checksum=0x1234             │
│ Source=192.168.0.10, Dest=15.15.15.15          │
│                                                 │
│ 변환된 IP 헤더:                                 │
│ Version=4, IHL=5, ToS=0, Length=40              │
│ ID=12345, Flags=2, Fragment=0                   │
│ TTL=63, Protocol=6, Checksum=0x5678             │
│ Source=3.3.3.3, Dest=15.15.15.15               │
│                                                 │
│ 원본 TCP 헤더:                                  │
│ Source Port=3000, Dest Port=80                  │
│ Seq=100, Ack=0, Flags=SYN                      │
│ Window=65535, Checksum=0xABCD                   │
│                                                 │
│ 변환된 TCP 헤더:                                │
│ Source Port=23000, Dest Port=80                 │
│ Seq=100, Ack=0, Flags=SYN                      │
│ Window=65535, Checksum=0xEFGH                   │
└─────────────────────────────────────────────────┘
```

## 웹서버의 인식

그러면 **이 웹서버는 192.168.0.10번이 접속했다고 인식할까? 아니면 3.3.3.3번이 접속했다고 인식을 할까?**

**당연하게도 3.3.3.3이 접속했다고 인식한다. 그래서 실제 PC가 아니라 3.3.3.3번이 접속했다고 인식하게 된다**.

**웹서버 입장에서는 TCP 연결이 3.3.3.3과 연결이 됐다고 판단한다. 실제로 192.168.0.10번과 된 것은 아니다. 그래서 이러한 이유 때문에 TCP 연결은 착각이라고 말하는 것이다. 실제 웹서버는 공유기와 연결되어 있지만 실제로는 PC가 연결한 것이다**.

```
연결 인식의 "착각" 현상:

웹서버의 관점:
┌─────────────────────────────────────────────────┐
│ 접속 로그:                                      │
│ [2024-01-15 10:30:25] 3.3.3.3:23000 연결       │
│ [2024-01-15 10:30:25] TCP SYN 수신             │
│ [2024-01-15 10:30:25] SYN-ACK 전송             │
│ [2024-01-15 10:30:25] TCP 연결 확립             │
│                                                 │
│ 서버가 인식하는 클라이언트:                      │
│ • IP: 3.3.3.3 (NAT Gateway)                    │
│ • 포트: 23000                                   │
│ • 실제 PC 존재를 전혀 모름                      │
└─────────────────────────────────────────────────┘

실제 PC의 관점:
┌─────────────────────────────────────────────────┐
│ 네트워크 상태:                                  │
│ $ netstat -an                                   │
│ TCP 192.168.0.10:3000 15.15.15.15:80 ESTABLISHED │
│                                                 │
│ PC가 인식하는 연결:                             │
│ • 자신의 IP: 192.168.0.10                      │
│ • 자신의 포트: 3000                             │
│ • 서버 IP: 15.15.15.15                         │
│ • 서버 포트: 80                                 │
│ • NAT Gateway 존재를 인식하지 못함              │
└─────────────────────────────────────────────────┘

실제 연결 구조:
┌─────────────────────────────────────────────────┐
│ PC ←─(가상연결)─→ 웹서버                        │
│ │                    ↑                          │
│ │              (착각된 연결)                      │
│ │                    │                          │
│ └→ NAT Gateway ←─(실제연결)─→ 웹서버              │
│                                                 │
│ • PC는 서버와 직접 연결된 줄 착각                │
│ • 서버는 NAT Gateway와 연결된 줄 착각           │
│ • 실제로는 NAT Gateway가 중간에서 중계          │
└─────────────────────────────────────────────────┘
```

## NAT 테이블 생성과 관리

**공유기에서 중요한 것은 이 Outbound가 일종의 트리거가 되어준다. 그래서 이 Outbound Traffic을 중심으로 뭔가가 변환하고 이와 관련된 자료구조가 생겨나는데, 이를 NAT 테이블이라고 한다. 그냥 간단한 데이터베이스라고 생각하면 된다**.

```
                         Private IP 192.168.0.1
 192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
  1                        2       3
```

그래서 **이 3번 지점을 통과할 때 공유기가 내부에서 외부로 나갈 때 메모리에 기록을 남긴다**.

```
NAT Table

Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     23000     │15.15.15.15  │     80      │   TCP
192.168.0.12│    2500    │     23001     │15.15.15.15  │     80      │   TCP
192.168.0.11│    4000    │     23002     │15.15.15.15  │     80      │   TCP
```

그러면 **이 외부로 나간 기록이 NAT Table에 남게 되는데 이러한 데이터가 언제 추가되냐 하면 바로 Outbound 될 때 남긴다. 반대로 Inbound 될 때는 추가되지 않는다**.

**이런 NAT 테이블에 기본적으로 추가가 될 때는 Outbound에 기초다**.

```
NAT 테이블 상세 구조:

테이블 필드 설명:
┌─────────────────────────────────────────────────┐
│ Local IP: 내부 네트워크 호스트 IP               │
│ Local Port: 내부 호스트가 사용하는 포트         │
│ External Port: NAT에서 할당한 외부 포트         │
│ Remote IP: 외부 서버/서비스 IP                  │
│ Remote Port: 외부 서버 포트                     │
│ Protocol: TCP, UDP, ICMP 등                    │
│ State: NEW, ESTABLISHED, FIN_WAIT 등           │
│ Timeout: 연결 유지 시간                        │
│ Creation Time: 엔트리 생성 시간                 │
└─────────────────────────────────────────────────┘

Symmetric NAT 특징:
┌─────────────────────────────────────────────────┐
│ 동일 내부 호스트라도 목적지별로 다른 외부 포트:  │
│                                                 │
│ 192.168.0.10 → 서버A (1.1.1.1:80):            │
│ External Port = 23000                          │
│                                                 │
│ 192.168.0.10 → 서버B (2.2.2.2:80):            │
│ External Port = 23001                          │
│                                                 │
│ 192.168.0.10 → 서버A (1.1.1.1:443):           │
│ External Port = 23002                          │
│                                                 │
│ 이는 보안성을 높이지만 P2P 통신을 어렵게 함     │
└─────────────────────────────────────────────────┘

테이블 관리:
┌─────────────────────────────────────────────────┐
│ 엔트리 생성: Outbound 패킷 처리 시              │
│ 엔트리 갱신: 양방향 트래픽 확인 시              │
│ 엔트리 삭제: 타임아웃 또는 TCP FIN/RST          │
│                                                 │
│ 타임아웃 설정:                                  │
│ • TCP ESTABLISHED: 7200초 (2시간)              │
│ • TCP SYN_SENT: 120초                          │
│ • UDP: 300초 (5분)                             │
│ • ICMP: 30초                                   │
└─────────────────────────────────────────────────┘
```

## 역방향 패킷 처리

그래서 **서버 입장에서는 이 공유기가 연결을 요청했다고 판단하고 SYN + ACK를 보내줘야 하는데 이때 목적지 IP는 3.3.3.3에 23000 포트가 될 것이다**.

**그 SYN + ACK가 공유기에 도착하게 된다**.

```
  IP              │ TCP         │ Payload
 Dst:3.3.3.3      │  Dst: 23000 │               
 Src:15.15.15.15  │  Src: 80    │
```

그러면 **공유기는 출발지 IP, 포트, 도착지 포트 이 3개의 키를 가지고 NAT 테이블에서 조회를 한 후에 주소를 한 번 더 변환한 다음에 실제 매핑되어 있는 내부망 PC에 보내주게 되는 것이다**.

```
192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                      4  
                  
                                    IP              │ TCP         │ Payload(data)
                                    Src:15.15.15.15 │  Src:80     │               
                                    Dst:192.168.0.10│  Dst:3000   │
```

```
역방향 패킷 처리 과정:

1. Inbound 패킷 수신:
┌─────────────────────────────────────────────────┐
│ NAT Gateway WAN 인터페이스로 패킷 도착:          │
│                                                 │
│ IP 헤더:                                        │
│ • 출발지: 15.15.15.15 (웹서버)                  │
│ • 목적지: 3.3.3.3 (NAT Gateway 공인 IP)        │
│                                                 │
│ TCP 헤더:                                       │
│ • 출발지 포트: 80 (웹서버)                      │
│ • 목적지 포트: 23000 (NAT 할당 포트)            │
└─────────────────────────────────────────────────┘

2. NAT 테이블 조회:
┌─────────────────────────────────────────────────┐
│ 조회 키 구성:                                   │
│ • Remote IP: 15.15.15.15                       │
│ • Remote Port: 80                              │
│ • External Port: 23000                         │
│                                                 │
│ 조회 결과:                                      │
│ Local IP: 192.168.0.10                         │
│ Local Port: 3000                               │
│ Protocol: TCP                                  │
│ State: ESTABLISHED                             │
└─────────────────────────────────────────────────┘

3. 역방향 변환:
┌─────────────────────────────────────────────────┐
│ 변환 전 (인터넷 → NAT):                         │
│ 15.15.15.15:80 → 3.3.3.3:23000                │
│                                                 │
│ 변환 후 (NAT → 내부):                          │
│ 15.15.15.15:80 → 192.168.0.10:3000            │
│                                                 │
│ 헤더 재작성:                                    │
│ • IP 목적지: 3.3.3.3 → 192.168.0.10           │
│ • TCP 목적지 포트: 23000 → 3000                │
│ • 체크섬 재계산                                 │
│ • TTL 감소                                     │
└─────────────────────────────────────────────────┘

4. 내부 전달:
┌─────────────────────────────────────────────────┐
│ LAN 인터페이스로 패킷 전송:                      │
│ • ARP 테이블 조회: 192.168.0.10의 MAC 주소      │
│ • 이더넷 헤더 생성                              │
│ • 스위치를 통해 해당 PC로 전달                  │
└─────────────────────────────────────────────────┘
```

## 다중 연결 시나리오

```
                         Private IP 192.168.0.1
 192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                         │
 192.168.0.11            │
 PC─────────────────────│
                         │
 192.168.0.12            │
 PC─────────────────────│
 
 
 NAT Table

Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     23000     │15.15.15.15  │     80      │   TCP
192.168.0.11│    4000    │     23002     │15.15.15.15  │     80      │   TCP
```

**이 내부망에 있는 PC 3대가 웹서버에 접속한다고 가정해보자. 실제 2개의 호스트가 웹서버 연결을 시도했지만 웹서버는 3.3.3.3번이 자기한테 2회, 2번 접속했다고 인식한다**.

```
다중 연결 관리:

웹서버 관점에서의 연결:
┌─────────────────────────────────────────────────┐
│ 접속 로그:                                      │
│ [10:30:25] 3.3.3.3:23000 연결 (실제: PC1)      │
│ [10:30:27] 3.3.3.3:23002 연결 (실제: PC2)      │
│                                                 │
│ 서버가 보는 상황:                               │
│ • 동일한 클라이언트(3.3.3.3)에서               │
│ • 다른 포트로 여러 번 접속                      │
│ • 실제 내부 PC들의 존재는 전혀 모름             │
└─────────────────────────────────────────────────┘

NAT Gateway 관리:
┌─────────────────────────────────────────────────┐
│ 포트 충돌 방지:                                 │
│ • 각 내부 연결마다 고유한 외부 포트 할당        │
│ • 포트 풀 관리 (예: 20000-65535)               │
│ • 사용 중인 포트 추적                           │
│                                                 │
│ 연결 추적:                                      │
│ • 각 연결의 상태 모니터링                       │
│ • TCP 상태 기반 타임아웃 관리                   │
│ • 연결 종료 시 포트 반환                        │
└─────────────────────────────────────────────────┘

확장성 고려사항:
┌─────────────────────────────────────────────────┐
│ 포트 고갈 문제:                                 │
│ • 이론적 최대: 65536개 포트                     │
│ • 실제 사용 가능: 약 45000개 (예약 포트 제외)   │
│ • 동시 연결 한계                                │
│                                                 │
│ 해결 방안:                                      │
│ • 포트 재사용 (TIME_WAIT 상태 관리)             │
│ • 여러 공인 IP 사용                            │
│ • 로드 밸런싱                                   │
│ • IPv6 도입                                    │
└─────────────────────────────────────────────────┘
```

이러한 **Symmetric NAT의 동작 원리**를 이해하면 **네트워크 트러블슈팅, 보안 설정, 그리고 P2P 애플리케이션 개발** 시 발생할 수 있는 문제들을 예측하고 해결할 수 있습니다.