## 공유기 작동원리 및 개요

**인터넷 공유기를 구현하는 기술은 여러 개가 있지만 요즘은 대부분 NAT(Network Address Translation) 기술로 구현되어 있다. 여기서 Network Address가 IP 주소이다. 그래서 정확하게는 인터넷 호스트 하나를 식별할 수 있는 IP 주소를 공유하는 것이다**.

**이 IP 주소도 여러 종류가 있다. 네트워크상에서의 식별자 역할을 하는 주소, 자기 자신을 가리키는 주소, 브로드캐스트 주소 등 여러 형태가 존재하는데 크게 두 가지로 분류하자면 하나는 Public 또는 Global IP 주소와 Private IP 이렇게 분류할 수 있다. 이 Private IP 주소는 네트워크의 특정 대역을 뽑아서 관리하고, 이 사설 IP는 인터넷 네트워크에서 유통될 수 없는 주소이다**.

```
IP 주소 분류:

Public IP (공인 IP):
┌─────────────────────────────────────────────────┐
│ • 인터넷에서 고유하게 식별 가능                  │
│ • IANA(Internet Assigned Numbers Authority) 관리│
│ • ISP에서 할당                                  │
│ • 직접 인터넷 통신 가능                         │
│                                                 │
│ 특징:                                           │
│ • 전 세계에서 유일                              │
│ • 라우팅 가능                                   │
│ • 비용 발생                                     │
│ • IPv4 주소 고갈 문제                          │
└─────────────────────────────────────────────────┘

Private IP (사설 IP):
┌─────────────────────────────────────────────────┐
│ • 내부 네트워크에서만 사용                       │
│ • RFC 1918에서 정의                            │
│ • 인터넷 직접 접근 불가                         │
│ • 무료로 사용 가능                              │
│                                                 │
│ 특징:                                           │
│ • 중복 사용 가능 (다른 네트워크에서)            │
│ • NAT 필요                                     │
│ • 보안성 향상                                   │
│ • IP 주소 절약                                 │
└─────────────────────────────────────────────────┘

특수 목적 IP:
┌─────────────────────────────────────────────────┐
│ 루프백 주소: 127.0.0.1                         │
│ • 자기 자신을 가리킴                            │
│ • 로컬 테스트용                                 │
│                                                 │
│ 브로드캐스트 주소: 255.255.255.255              │
│ • 네트워크 내 모든 호스트에게 전송              │
│                                                 │
│ 멀티캐스트 주소: 224.0.0.0~239.255.255.255     │
│ • 특정 그룹에게 전송                            │
│                                                 │
│ 링크 로컬 주소: 169.254.0.0/16                 │
│ • DHCP 실패 시 자동 할당                       │
└─────────────────────────────────────────────────┘
```

## NAT 기술 개념

그래서 **공유기는 이 사설 IP 주소를 사용하여 NAT 기술이 적용한 장치이다. 이 주소 변환, 즉 IP 주소를 간단하게 말해서 조작하겠다는 의미이다. 그래서 보통 주소와 포트 번호 모두를 제어한다. 그래서 이 패킷의 헤더 TCP/IP 4계층 수준에서 제어한다. 실제로 호스트 하나당 IP 주소가 하나가 존재해야 하는데 이 하나의 주소를 여러 대의 기기가 사용할 수 있게 제어해주는 기술이다. 따라서 인터넷 IP 주소 부족 문제를 해결해준다**.

```
NAT 동작 원리:

기본 개념:
┌─────────────────────────────────────────────────┐
│ 내부 네트워크의 여러 기기가                            │
│ 하나의 공인 IP로 인터넷에 접속                         │
│                                                 │
│ 192.168.0.10 ┐                                  │
│ 192.168.0.11 ├── NAT 공유기 ──→ 3.3.3.3           │
│ 192.168.0.12 ┘   (주소 변환)    (공인 IP)          │
│                                                 │
│ 여러 개 사설 IP → 하나의 공인 IP                      │
└─────────────────────────────────────────────────┘

패킷 헤더 변환:
┌─────────────────────────────────────────────────┐
│ 내부 → 외부 (Outbound):                           │
│ 원본: 192.168.0.10:12345 → 9.9.9.9:80            │
│ 변환: 3.3.3.3:5000 → 9.9.9.9:80                  │
│                                                 │
│ 외부 → 내부 (Inbound):                            │ 
│ 원본: 9.9.9.9:80 → 3.3.3.3:5000                  │
│ 변환: 9.9.9.9:80 → 192.168.0.10:12345            │
│                                                 │
│ NAT 테이블:                                       │
│ 내부 IP:포트 ←→ 외부 포트 ←→ 목적지                    │
│ 192.168.0.10:12345 ←→ 5000 ←→ 9.9.9.9:80         │
└─────────────────────────────────────────────────┘

NAT의 이점:
┌─────────────────────────────────────────────────┐
│ IP 주소 절약:                                   │
│ • IPv4 주소 고갈 문제 완화                      │
│ • 하나의 공인 IP로 수십 대 기기 지원                │
│                                                 │
│ 보안 강화:                                      │
│ • 내부 네트워크 구조 은닉                       │
│ • 외부에서 직접 접근 차단                       │
│ • 스테이트풀 방화벽 역할                        │
│                                                 │
│ 관리 편의성:                                    │
│ • 내부 IP 자유롭게 할당                        │
│ • DHCP와 연동                                  │
│ • 플러그 앤 플레이                              │
└─────────────────────────────────────────────────┘
```

## 공유기의 보안성과 P2P 문제

**공유기의 작동 원리가 여러 가지가 존재하는데 그중에서 Symmetric 방식 같은 경우 패킷 필터링 방화벽과 비슷한 보안성을 제공한다**.

그래서 **이 P2P(피어 투 피어) 통신을 할 때 NAT 기술이 적용된 공유기를 사용하고 있으면 공유기에서 방해를 한다**.

```
NAT와 P2P 문제:

일반적인 클라이언트-서버 통신:
┌─────────────────────────────────────────────────┐
│ 클라이언트 (192.168.0.10) ──→ 서버 (9.9.9.9)   │
│ • 클라이언트가 연결 시작                        │
│ • NAT가 연결 상태 추적                         │
│ • 서버 응답을 올바른 내부 IP로 전달             │
│ • 문제없이 동작                                 │
└─────────────────────────────────────────────────┘

P2P 통신의 문제:
┌─────────────────────────────────────────────────┐
│ PC A (192.168.0.10) ←──→ PC B (10.0.0.20)      │
│         │                      │                │
│     NAT A                   NAT B               │
│         │                      │                │
│      3.3.3.3 ←──────────→ 4.4.4.4              │
│                                                 │
│ 문제:                                           │
│ • 양쪽 모두 NAT 뒤에 있음                      │
│ • 서로 직접 연결 불가                           │
│ • 외부에서 내부로 연결 시작 불가                │
└─────────────────────────────────────────────────┘

P2P 해결 방법:
┌─────────────────────────────────────────────────┐
│ STUN (Session Traversal Utilities for NAT):    │
│ • 자신의 공인 IP:포트 발견                     │
│ • NAT 타입 판별                                │
│                                                 │
│ TURN (Traversal Using Relays around NAT):      │
│ • 중계 서버 경유                                │
│ • 직접 연결 실패 시 사용                       │
│                                                 │
│ ICE (Interactive Connectivity Establishment):  │
│ • STUN + TURN 통합                             │
│ • WebRTC에서 사용                              │
│                                                 │
│ UPnP/NAT-PMP:                                  │
│ • 자동 포트 포워딩                              │
│ • 애플리케이션이 NAT 설정 변경                  │
└─────────────────────────────────────────────────┘
```

## 공유기 구조에 따른 분류

**이 공유기는 내부 논리적 구조에 따라서 크게 두 개로 나뉜다. 하나는 Cone 방식과 Symmetric 방식이 있다**.

**외부랑 연결되는 포트의 단위가 Host로 가면 Cone 방식이고 Symmetric은 TCP 세션마다 외부 포트를 지정한다**.

- **Cone NAT**
    - **Host 단위로 외부 포트 지정**
    - **Full Cone**
    - **Restricted Cone**
        - **IP Address restricted**
        - **Port restricted**
- **Symmetric NAT (보안성이 좋음)**
    - **TCP 세션마다 외부 포트 지정**

그래서 **외부 포트를 지정하는 것이 NAT에서 어떤 결과인데 이걸 어떤 단위로 지정해서 처리할 것이냐에 따라서 달라진다**.

```
NAT 타입별 상세 비교:

Full Cone NAT:
┌─────────────────────────────────────────────────┐
│ 특징:                                           │
│ • 내부 호스트당 하나의 외부 포트 할당            │
│ • 모든 외부 호스트가 해당 포트로 접근 가능       │
│                                                 │
│ 동작:                                           │
│ 192.168.0.10:1234 ←→ 3.3.3.3:5000             │
│ 외부 어떤 IP:포트든 3.3.3.3:5000으로 접근 가능  │
│                                                 │
│ 장점: P2P 연결 용이                            │
│ 단점: 보안 취약                                 │
└─────────────────────────────────────────────────┘

Restricted Cone NAT:
┌─────────────────────────────────────────────────┐
│ IP Address Restricted:                          │
│ • 내부에서 먼저 통신한 IP만 접근 가능           │
│ • 포트는 상관없음                               │
│                                                 │
│ Port Restricted:                                │
│ • 내부에서 먼저 통신한 IP:포트만 접근 가능      │
│ • 가장 엄격한 제한                              │
│                                                 │
│ 예시:                                           │
│ 내부에서 9.9.9.9:80에 접속                     │
│ → 9.9.9.9에서만 역방향 접근 가능 (IP 제한)      │
│ → 9.9.9.9:80에서만 역방향 접근 가능 (포트 제한) │
└─────────────────────────────────────────────────┘

Symmetric NAT:
┌─────────────────────────────────────────────────┐
│ 특징:                                           │
│ • 목적지별로 다른 외부 포트 할당                │
│ • 가장 높은 보안성                              │
│ • P2P 연결 매우 어려움                         │
│                                                 │
│ 동작:                                           │
│ 192.168.0.10 → 9.9.9.9: 외부포트 5000 사용    │
│ 192.168.0.10 → 8.8.8.8: 외부포트 5001 사용    │
│                                                 │
│ 보안: 각 세션이 완전히 독립적                   │
│ 문제: NAT 홀 펀칭 불가능                       │
└─────────────────────────────────────────────────┘

실제 동작 예시:
┌─────────────────────────────────────────────────┐
│ Cone NAT:                                       │
│ 내부 192.168.0.10:1234 → 외부 3.3.3.3:5000    │
│ 모든 목적지에 대해 동일한 외부 포트 사용        │
│                                                 │
│ Symmetric NAT:                                  │
│ 내부 192.168.0.10:1234 → 서버A: 3.3.3.3:5000  │
│ 내부 192.168.0.10:1234 → 서버B: 3.3.3.3:5001  │
│ 목적지마다 다른 외부 포트 사용                  │
└─────────────────────────────────────────────────┘
```

## 공유기 네트워크 구성

**IP 주소는 크게 Public과 Private으로 구성되어 있다. 그래서 인터넷이라고 하는 것은 기본적으로 Public 네트워크이다, 공용망이다. 그런데 NAT를 지원하는 공유기가 있으면 이 공유기를 중심으로 네트워크가 공유기 안쪽은 내부 그 밖은 외부로 나눌 수 있다. 그래서 이 내부를 보통은 Private Network 대역이라고 부른다**.

```
PC ─────────────────
192.168.0.10        │
PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server B
192.168.0.11         │   Private IP 192.168.0.1      │           9.9.9.9
PC ─────────────────     Global IP   3.3.3.3         │
192.168.0.12                                         │     
                     │                            Web Server A
                     │                             15.15.15.15
   < Private Network >         <Public Network>
   사설 IP 주소 사용
```

**그래서 이 사설 IP 주소 대역대가 있다**

- **192.168.0.0/16 (192.168.0.0 ~ 192.168.255.255)**
- **172.16.0.0/12 (172.16.0.0 ~ 172.31.255.255)**
- **10.0.0.0/8 (10.0.0.0 ~ 10.255.255.255)**

그래서 **사설 IP라고 하는 것은 이 퍼블릭 네트워크에서 해당 대역의 주소를 사용하는 곳이 없다**.

```
사설 IP 주소 대역 (RFC 1918):

Class A: 10.0.0.0/8
┌─────────────────────────────────────────────────┐
│ 범위: 10.0.0.0 ~ 10.255.255.255                │
│ 서브넷 마스크: 255.0.0.0                        │
│ 총 주소 수: 16,777,216개                       │
│                                                 │
│ 사용 사례:                                      │
│ • 대기업 내부 네트워크                          │
│ • 데이터센터                                    │
│ • 클라우드 환경                                 │
└─────────────────────────────────────────────────┘

Class B: 172.16.0.0/12
┌─────────────────────────────────────────────────┐
│ 범위: 172.16.0.0 ~ 172.31.255.255              │
│ 서브넷 마스크: 255.240.0.0                      │
│ 총 주소 수: 1,048,576개                        │
│                                                 │
│ 사용 사례:                                      │
│ • 중간 규모 기업                                │
│ • 도커 컨테이너 기본 네트워크                   │
│ • VPN 네트워크                                 │
└─────────────────────────────────────────────────┘

Class C: 192.168.0.0/16
┌─────────────────────────────────────────────────┐
│ 범위: 192.168.0.0 ~ 192.168.255.255            │
│ 서브넷 마스크: 255.255.0.0                      │
│ 총 주소 수: 65,536개                           │
│                                                 │
│ 사용 사례:                                      │
│ • 가정용 공유기 (192.168.1.0/24)               │
│ • 소규모 사무실                                 │
│ • 테스트 환경                                   │
└─────────────────────────────────────────────────┘

일반적인 가정용 설정:
┌─────────────────────────────────────────────────┐
│ 공유기 IP: 192.168.1.1 (게이트웨이)             │
│ DHCP 범위: 192.168.1.100 ~ 192.168.1.200       │
│ 서브넷 마스크: 255.255.255.0                    │
│ DNS 서버: 8.8.8.8, 1.1.1.1                    │
│                                                 │
│ 기기 할당 예시:                                 │
│ • PC: 192.168.1.101                           │
│ • 스마트폰: 192.168.1.102                      │
│ • 노트북: 192.168.1.103                        │
│ • IoT 기기: 192.168.1.104                     │
└─────────────────────────────────────────────────┘

네트워크 분리:
┌─────────────────────────────────────────────────┐
│ DMZ: 192.168.1.0/24 (서버용)                   │
│ LAN: 192.168.2.0/24 (일반 사용자)              │
│ Guest: 192.168.3.0/24 (게스트 네트워크)        │
│ IoT: 192.168.4.0/24 (IoT 기기)                │
│                                                 │
│ 보안상 분리하여 관리                            │
│ VLAN 태깅으로 논리적 분리                      │
└─────────────────────────────────────────────────┘
```

이러한 **NAT 기술과 사설 IP 주소 체계**를 통해 **제한된 IPv4 주소 자원을 효율적으로 활용**하면서 **내부 네트워크의 보안성도 향상**시킬 수 있습니다. 하지만 **P2P 통신과 일부 애플리케이션에서는 추가적인 설정이나 기술이 필요**할 수 있습니다.