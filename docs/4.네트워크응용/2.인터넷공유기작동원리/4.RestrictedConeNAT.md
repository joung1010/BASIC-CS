# (IP) Restricted Cone NAT

## IP Restricted Cone NAT 개념

```
                      Private IP 192.168.0.1
192.168.0.10:3000      Global IP   3.3.3.3:8080                15.15.15.15:5555
                                                               15.15.15.15:6666
                                                               15.15.15.15:7777
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                            │                            │      
                            │                            └───── Web Server 9.9.9.9 
 192.168.0.11               │                                   
 PC──────────────────────────
 
 
 Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     8080      │  15.15.15.15│     ANY     │   TCP
```

**Full Cone 방식은 너무 아무나 막 접속이 가능하다 보니 문제가 발생할 가능성이 높다 하여 여기에 어떠한 제한을 좀 두는 방식이 Restricted Cone 방식이다**.

**크게 IP와 포트 두 가지 방식이 있다. 근데 특별히 명시하지 않으면 IP이다. 이 Full Cone 방식은 Remote IP가 어떤 것이든 신경 쓰지 않겠다 하니 전혀 기록이 없는 9.9.9.9번과 같은 PC가 매핑 포트만 알면 접근이 가능하는 문제가 발생한다. 그래서 아무 원격 IP나 받지 말고 실제 접속한 원격지 IP를 기록해두고 패킷이 인바운드될 때 External Port와 더불어서 Remote IP, 상대방의 IP도 함께 확인하자. 이렇게 함으로써 통신 기록이 없는 외부에서 직접 접속하려고 오면 NAT 입장에서 한 번도 통신한 기록이 없기 때문에 해당 요청을 Drop 한다. 근데 이 Remote Port를 ANY라고 했는데 이는 한 번이라도 통신 기록이 있는 호스트라면 포트 번호를 신경 쓰지 않고 접속이 가능하다**.

```
IP Restricted Cone NAT 동작 원리:

보안 강화 메커니즘:
┌─────────────────────────────────────────────────┐
│ Full Cone vs IP Restricted Cone:                │
│                                                 │
│ Full Cone:                                      │
│ • Remote: ANY                                   │
│ • 모든 외부 호스트 접근 허용                    │
│ • 보안 위험 높음                                │
│                                                 │
│ IP Restricted Cone:                             │
│ • Remote IP: 통신 기록이 있는 IP만              │
│ • Remote Port: ANY (포트는 제한 없음)           │
│ • 보안성 향상                                   │
└─────────────────────────────────────────────────┘

패킷 필터링 과정:
┌─────────────────────────────────────────────────┐
│ 1. Outbound 연결 설정:                          │
│   192.168.0.10:3000 → 15.15.15.15:5555         │
│   NAT 매핑: 3.3.3.3:8080 ↔ 192.168.0.10:3000  │
│   기록: Remote IP = 15.15.15.15                 │
│                                                 │
│ 2. 허용되는 Inbound 패킷:                       │
│   출발지: 15.15.15.15:5555 → 3.3.3.3:8080      │
│   출발지: 15.15.15.15:6666 → 3.3.3.3:8080      │
│   출발지: 15.15.15.15:7777 → 3.3.3.3:8080      │
│   → 모든 포트에서의 접근 허용                   │
│                                                 │
│ 3. 차단되는 Inbound 패킷:                       │
│   출발지: 9.9.9.9:80 → 3.3.3.3:8080           │
│   → 통신 기록이 없는 IP이므로 드롭              │
└─────────────────────────────────────────────────┘

실제 시나리오:
┌─────────────────────────────────────────────────┐
│ 웹서버 클러스터 환경:                           │
│                                                 │
│ 로드밸런서: 15.15.15.15                         │
│ ├─ 웹서버1: 15.15.15.15:5555                   │
│ ├─ 웹서버2: 15.15.15.15:6666                   │
│ └─ 웹서버3: 15.15.15.15:7777                   │
│                                                 │
│ 클라이언트가 로드밸런서에 접속:                 │
│ • 초기 연결: 15.15.15.15:80                    │
│ • 로드밸런싱으로 다른 포트 서버들과 통신        │
│ • IP Restricted Cone에서 모든 포트 허용        │
│ • 원활한 서비스 제공                            │
└─────────────────────────────────────────────────┘
```

# Port Restricted Cone NAT

```
                      Private IP 192.168.0.1
192.168.0.10:3000      Global IP   3.3.3.3:8080                15.15.15.15:5555
                                                               15.15.15.15:6666
192.168.0.10:3001                                              15.15.15.15:7777
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                            │                            │      
                            │                            └───── Web Server 9.9.9.9 
 192.168.0.11               │                                   
 PC──────────────────────────
 
 
 Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     8080      │ 15.15.15.15 │     5555    │   TCP
192.168.0.10│    3001    │     8080      │ 15.15.15.15 │     7777    │   TCP
```

**어떠한 제한을 걸면 걸수록 보안은 뛰어나진다. 당연하게도 접속을 차단할 수 있으니 내부를 보호할 수 있다는 장점이 있다. 기존 IP에서 포트 번호까지 확인을 하게 되면 Port Restricted Cone 방식이 된다**.

**192.168.0.10:3000이 15.15.15.15:5555 서버에 접속한다. 이때 매핑 포트를 8080을 가져간다. 이때 동일한 PC가 웹서버에 한 번 더 접속하게 된다면 예를 들어 3001번 같은 포트를 열어서 15.15.15.15:7777에 접속한다고 하면 매핑된 External Port 8080번은 그대로일까 아니면 새롭게 매핑된 포트 번호가 생길까??**

**이 Restricted Cone 방식은 호스트에 포트 번호를 매핑할 때 식별만 가능하다면 포트 번호는 변경되지 않고 유지한다. 그래서 8080포트는 유지한 채로 새롭게 NAT 테이블에 새로운 ROW 한 줄이 추가된다**.

```
Port Restricted Cone NAT 특징:

포트 매핑 정책:
┌─────────────────────────────────────────────────┐
│ 동일 내부 호스트의 포트 재사용:                  │
│                                                 │
│ 최초 연결:                                      │
│ 192.168.0.10:3000 → 15.15.15.15:5555           │
│ External Port: 8080 할당                       │
│                                                 │
│ 추가 연결:                                      │
│ 192.168.0.10:3001 → 15.15.15.15:7777           │
│ External Port: 8080 재사용                     │
│                                                 │
│ 조건:                                           │
│ • 동일한 내부 IP (192.168.0.10)                │
│ • 포트 충돌이 없는 경우                         │
│ • 기존 매핑과 구분 가능한 경우                  │
└─────────────────────────────────────────────────┘

NAT 테이블 관리:
┌─────────────────────────────────────────────────┐
│ 엔트리 추가 조건:                               │
│ • 새로운 목적지 IP:포트 조합                    │
│ • 새로운 내부 포트                              │
│                                                 │
│ 포트 매핑 유지:                                 │
│ • 동일 호스트는 가능한 같은 External Port 사용  │
│ • 포트 풀 효율적 활용                           │
│ • 관리 복잡도 감소                              │
│                                                 │
│ 보안 검사:                                      │
│ • IP + 포트 조합으로 엄격한 필터링              │
│ • 허용된 연결만 통과                            │
└─────────────────────────────────────────────────┘

실제 패킷 필터링:
┌─────────────────────────────────────────────────┐
│ 허용되는 패킷:                                  │
│ • 15.15.15.15:5555 → 3.3.3.3:8080             │
│ • 15.15.15.15:7777 → 3.3.3.3:8080             │
│                                                 │
│ 차단되는 패킷:                                  │
│ • 15.15.15.15:6666 → 3.3.3.3:8080             │
│   (통신 기록 없는 포트)                        │
│ • 9.9.9.9:80 → 3.3.3.3:8080                   │
│   (통신 기록 없는 IP)                          │
└─────────────────────────────────────────────────┘
```

## Symmetric NAT와의 비교

**이렇게 보면 Port Restricted Cone NAT 방식이 Symmetric NAT와 유사하다고 생각할 수 있다**.

```
                         Private IP 192.168.0.1
 192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
  

NAT Table

Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     23000     │15.15.15.15  │    5555     │   TCP
192.168.0.10│    3001    │     23001     │15.15.15.15  │    6666     │   TCP
192.168.0.10│    3000    │     23002     │15.15.15.15  │    7777     │   TCP
```

**Symmetric NAT 방식은 어떤 새로운 원격지 IP와 Port와 통신이 발생하면 바로 NAT 테이블에 추가해버린다. 즉 External Port를 아끼지 않고 끊임없이 계속 바꿔 가면서 사용한다**.

그래서 **Symmetric NAT 방식에서는 P2P 통신이 매우 제한적이다**.

```
NAT 방식별 상세 비교:

Port Restricted Cone vs Symmetric NAT:
┌─────────────────────────────────────────────────┐
│ Port Restricted Cone:                           │
│ • 동일 호스트는 External Port 재사용            │
│ • 호스트 단위 포트 매핑                         │
│ • 제한적 P2P 가능                              │
│                                                 │
│ Symmetric NAT:                                  │
│ • 세션마다 새로운 External Port 할당            │
│ • 목적지별 독립적 매핑                          │
│ • P2P 매우 어려움                              │
└─────────────────────────────────────────────────┘

포트 할당 정책:
┌─────────────────────────────────────────────────┐
│ Port Restricted Cone:                           │
│ 192.168.0.10 → 서버A:포트1 = External Port X   │
│ 192.168.0.10 → 서버A:포트2 = External Port X   │
│ 192.168.0.10 → 서버B:포트1 = External Port X   │
│                                                 │
│ Symmetric NAT:                                  │
│ 192.168.0.10 → 서버A:포트1 = External Port X   │
│ 192.168.0.10 → 서버A:포트2 = External Port Y   │
│ 192.168.0.10 → 서버B:포트1 = External Port Z   │
└─────────────────────────────────────────────────┘

P2P 연결 가능성:
┌─────────────────────────────────────────────────┐
│ Full Cone: ★★★★★ (매우 쉬움)                   │
│ IP Restricted: ★★★★☆ (쉬움)                   │
│ Port Restricted: ★★★☆☆ (보통)                 │
│ Symmetric: ★☆☆☆☆ (매우 어려움)                │
│                                                 │
│ 보안성:                                         │
│ Full Cone: ★☆☆☆☆ (낮음)                       │
│ IP Restricted: ★★☆☆☆ (보통-낮음)              │
│ Port Restricted: ★★★☆☆ (보통)                 │
│ Symmetric: ★★★★★ (높음)                       │
└─────────────────────────────────────────────────┘
```

## P2P 애플리케이션의 확산

그러면 **이 P2P 통신을 하는 것이 게임밖에 없을까??? 코로나 시대를 맞으면서 많은 사람들이 화상으로 뭔가를 많이 하게 된다. 이 화상 역시 P2P 통신을 하게 된다 왜냐하면 이것 또한 영상 미디어이기 때문에 서버를 거쳐서 하게 되면 트래픽이 폭발적으로 증가하고 성능도 떨어진다**.

```
P2P가 필요한 애플리케이션들:

실시간 통신 애플리케이션:
┌─────────────────────────────────────────────────┐
│ 화상 회의:                                      │
│ • Zoom, Teams, Google Meet                     │
│ • WebRTC 기반 브라우저 통화                     │
│ • 1:1 영상 통화                                │
│                                                 │
│ 음성 통화:                                      │
│ • Skype, Discord                               │
│ • VoIP 서비스                                  │
│ • 인터넷 전화                                   │
│                                                 │
│ 메신저:                                         │
│ • WhatsApp, Telegram                          │
│ • 파일 전송                                     │
│ • 미디어 공유                                   │
└─────────────────────────────────────────────────┘

미디어 스트리밍:
┌─────────────────────────────────────────────────┐
│ 라이브 스트리밍:                                │
│ • 트위치, 유튜브 라이브                         │
│ • 개인 방송                                     │
│ • 실시간 이벤트 중계                            │
│                                                 │
│ P2P 방송:                                      │
│ • 시청자 간 트래픽 분산                         │
│ • CDN 비용 절약                                │
│ • 지역 캐싱                                     │
└─────────────────────────────────────────────────┘

파일 공유:
┌─────────────────────────────────────────────────┐
│ BitTorrent:                                     │
│ • 대용량 파일 분산 다운로드                     │
│ • 리눅스 배포판, 게임 업데이트                  │
│                                                 │
│ 동기화 서비스:                                  │
│ • Dropbox, OneDrive                            │
│ • LAN 동기화                                   │
│ • 로컬 네트워크 최적화                          │
└─────────────────────────────────────────────────┘

코로나19 영향:
┌─────────────────────────────────────────────────┐
│ 화상 회의 폭증:                                 │
│ • 재택근무 확산                                 │
│ • 온라인 교육                                   │
│ • 원격 의료                                     │
│                                                 │
│ 트래픽 증가:                                    │
│ • 2020년 화상회의 트래픽 600% 증가              │
│ • 가정용 인터넷 대역폭 부족                     │
│ • P2P 기술의 중요성 부각                       │
└─────────────────────────────────────────────────┘
```

## WebRTC와 NAT 극복

```
WebRTC (Web Real-Time Communication):

브라우저 기반 P2P:
┌─────────────────────────────────────────────────┐
│ • JavaScript API로 P2P 연결                    │
│ • 플러그인 없이 브라우저에서 직접 통신          │
│ • 음성, 영상, 데이터 채널 지원                  │
│                                                 │
│ NAT 극복 메커니즘:                              │
│ • ICE (Interactive Connectivity Establishment) │
│ • STUN/TURN 서버 활용                          │
│ • 자동 NAT 타입 감지                           │
└─────────────────────────────────────────────────┘

실제 연결 과정:
┌─────────────────────────────────────────────────┐
│ 1. 시그널링 서버 통한 연결 협상:                │
│   • SDP (Session Description Protocol) 교환    │
│   • ICE 후보 정보 교환                         │
│                                                 │
│ 2. NAT 극복 시도:                              │
│   • Host 후보: 직접 연결 시도                  │
│   • Server Reflexive: STUN 통한 NAT 매핑      │
│   • Relay: TURN 서버 경유                      │
│                                                 │
│ 3. 최적 경로 선택:                              │
│   • 지연시간, 대역폭 고려                       │
│   • P2P 우선, 실패 시 중계                     │
└─────────────────────────────────────────────────┘

기업/가정 환경별 대응:
┌─────────────────────────────────────────────────┐
│ 가정용 공유기:                                  │
│ • 대부분 Cone NAT 사용                         │
│ • UPnP 지원으로 자동 포트 포워딩               │
│ • WebRTC 대부분 성공                           │
│                                                 │
│ 기업용 방화벽:                                  │
│ • Symmetric NAT 주로 사용                      │
│ • TURN 서버 필수                               │
│ • 추가 네트워크 설정 필요                       │
└─────────────────────────────────────────────────┘
```

이러한 **Restricted Cone NAT의 특성**을 이해하면 **보안과 P2P 연결성 간의 균형점**을 찾을 수 있고, **현대 인터넷 애플리케이션의 요구사항에 맞는 네트워크 설정**을 선택할 수 있습니다.