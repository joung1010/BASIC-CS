# Full Cone 방식

## Full Cone NAT의 보안 특성

```
                      Private IP 192.168.0.1
192.168.0.10            Global IP   3.3.3.3                    15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                        1
  
  NAT Table

Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     23000     │15.15.15.15  │     80      │   TCP
192.168.0.12│    2500    │     23001     │15.15.15.15  │     80      │   TCP
192.168.0.11│    4000    │     23002     │15.15.15.15  │     80      │   TCP

                                          IP              │ TCP         │ Payload(data)
                                         Src:192.168.0.10 │  Src:3000   │               
                                         Dst:15.15.15.15  │  Dst:80     │
```

**Symmetric 방식이 보안성이 좋다고 하는 이유는 NAT Gateway는 구조적으로 패킷을 필터링하는 방화벽 역할을 하게 된다. 이 NAT 테이블에 어떠한 값이 추가가 되기 위해서는 Outbound가 발생해야 한다. 즉, 우리 쪽에서 뭔가 나가는 패킷이 있으면 그거에 의해서 추가가 되는 방식이다. 나와 통신을 했던 서버에 대한 응답은 통과가 잘 되는데 만약 한 번도 통신이 되지 않는 서버에서 패킷을 보내게 된다면 라우팅 테이블에서 조회했을 때(서버 IP와 Port, 클라이언트 Port) 없는 경우 통과가 되지 않는다**.

```
Symmetric NAT의 보안 메커니즘:

상태 기반 필터링 (Stateful Filtering):
┌─────────────────────────────────────────────────┐
│ 허용되는 패킷:                                  │
│ • 내부에서 시작된 연결의 응답 패킷               │
│ • NAT 테이블에 정확히 매칭되는 패킷              │
│                                                 │
│ 차단되는 패킷:                                  │
│ • 외부에서 시작하려는 새로운 연결               │
│ • NAT 테이블에 매칭되지 않는 패킷               │
│ • 스푸핑된 출발지 주소를 가진 패킷              │
└─────────────────────────────────────────────────┘

NAT 테이블 조회 과정:
┌─────────────────────────────────────────────────┐
│ 인바운드 패킷 처리:                             │
│                                                 │
│ 1. 패킷 도착: 외부 → 3.3.3.3:23000             │
│ 2. 조회 키 구성:                               │
│    • Remote IP: 패킷의 출발지 IP                │
│    • Remote Port: 패킷의 출발지 포트            │
│    • External Port: 패킷의 목적지 포트          │
│ 3. NAT 테이블 검색                             │
│ 4. 매칭 결과:                                  │
│    • 발견: 내부로 전달                         │
│    • 미발견: 패킷 드롭                         │
└─────────────────────────────────────────────────┘

보안 효과:
┌─────────────────────────────────────────────────┐
│ 자동 방화벽 역할:                               │
│ • 외부 스캔 공격 차단                           │
│ • 무작위 포트 접근 시도 차단                    │
│ • DDoS 공격 완화                               │
│                                                 │
│ 네트워크 은닉:                                  │
│ • 내부 네트워크 구조 숨김                       │
│ • 내부 호스트 직접 접근 불가                    │
│ • 포트 스캔 무효화                              │
└─────────────────────────────────────────────────┘
```

## P2P 통신의 문제점

**너무나 안정적이게 보이지만 반대로 이것 때문에 문제가 발생하는 경우도 있다. 바로 게임할 때 주로 발생한다. 그러면 왜 게임이 문제가 되냐 하면 P2P(각 단말끼리 직접 데이터 송수신) 통신을 할 때 문제가 된다. 컴퓨터들이 각자 게임에 연결하여 FPS 게임을 한다고 가정했을 때 서버를 거쳐서 통신을 하면 느리기 때문에 직접 통신을 해야 되는데 된다. 그래서 클라이언트에서 직접 통신을 위한 포트 번호를 열어 두더라도 Symmetric 방식에서는 이 접근이 불가능하다**.

```
P2P 통신의 필요성:

게임에서의 요구사항:
┌─────────────────────────────────────────────────┐
│ 실시간 멀티플레이어 게임:                       │
│ • FPS 게임 (Counter-Strike, 배틀그라운드)       │
│ • RTS 게임 (스타크래프트, 에이지 오브 엠파이어)  │
│ • 레이싱 게임                                   │
│                                                 │
│ 지연 시간 요구사항:                             │
│ • FPS: 20ms 이하                               │
│ • RTS: 100ms 이하                              │
│ • 일반 게임: 200ms 이하                        │
└─────────────────────────────────────────────────┘

서버 중계 vs P2P 직접 연결:
┌─────────────────────────────────────────────────┐
│ 서버 중계 방식:                                 │
│ 플레이어A → 게임서버 → 플레이어B                │
│ • 지연시간: 두 배로 증가                        │
│ • 서버 부하: 모든 트래픽 처리                   │
│ • 대역폭: 서버 용량에 의존                      │
│                                                 │
│ P2P 직접 연결:                                  │
│ 플레이어A ←──────────→ 플레이어B                │
│ • 지연시간: 최소화                              │
│ • 서버 부하: 거의 없음                          │
│ • 대역폭: 각자의 연결 속도 활용                 │
└─────────────────────────────────────────────────┘

Symmetric NAT의 P2P 차단:
┌─────────────────────────────────────────────────┐
│ 문제 시나리오:                                  │
│                                                 │
│ 플레이어A (NAT뒤) ←─X─→ 플레이어B (NAT뒤)       │
│                                                 │
│ • 양쪽 모두 외부에서 들어오는 연결 차단          │
│ • 먼저 연결을 시도한 측만 성공                  │
│ • 동시 연결 시도 시 실패                        │
└─────────────────────────────────────────────────┘
```

## Full Cone NAT 솔루션

그래서 **이러한 니즈를 해결해야 될 필요가 생겼다. 이런 것을 홀 펀칭이라고 하는데 위에서 NAT 테이블에 레코드가 전혀 없을 때도 통신이 되게 하려면 어떻게 해야 할까?? 간단하다. 그냥 많이 열어두면 된다. 반대로 보안성을 떨어지게 된다. 컬리전, 즉 내부에 엉뚱한 호스트에 트래픽을 보낸다든지 하는 문제가 발생할 수 있다**.

```
                      Private IP 192.168.0.1
192.168.0.10:3000      Global IP   3.3.3.3:8080                15.15.15.15
 PC ─────────────────── NAT Gateway ──────── Public Internet ──Web Server
                            │                            │      
                            │                            └───── Web Server 9.9.9.9 
 192.168.0.11               │                                   
 PC──────────────────────────
 
 
 Local IP    │ Local Port │ External Port │ Remote IP   │ Remote Port │ Protocol
192.168.0.10│    3000    │     8080      │    ANY      │     ANY     │   TCP
```

**192.168.0.10 호스트를 3.3.3.3:8080번에 매핑하므로 3.3.3.3:8080으로 유입되는 모든 것을 192.168.0.10:3000으로 보낸다**.

**192.168.0.10 호스트가 3000번 포트를 열어서 15.15.15.15의 80번 포트에 접속한다고 했을 때 그때 External Port 8080이라고 NAT 테이블에 매핑을 해버린 것이다. 그러면 이 Cone 방식은 호스트랑 포트를 External Port 하나에 매핑한다. 그래서 Symmetric에서는 3가지 키를 가지고 조회해서 이 트래픽이 나간 적 있는지 없는지를 찾았다면 Full Cone 방식에서는 딱 하나의 레코드만 추가가 된다. 그래서 위에서 한 번도 통신한 적이 없던 서버도 192.168.0.10 PC에 접속할 수 있는 것이다. 즉 NAT 테이블이 단 하나만 존재하기 때문에 서버쪽 IP와 포트는 상관하지 않고 오직 포트 번호만을 가지고 NAT 테이블에서 조회해서 통과시킨다. 내부 호스트를 찾아서 트래픽을 전송한다**.

```
Full Cone NAT 동작 원리:

NAT 테이블 구조 비교:
┌─────────────────────────────────────────────────┐
│ Symmetric NAT:                                  │
│ Local IP | Local Port | Ext Port | Remote | Protocol │
│ 192.168.0.10 | 3000 | 23000 | 15.15.15.15:80 | TCP │
│ 192.168.0.10 | 3000 | 23001 | 9.9.9.9:80 | TCP    │
│                                                 │
│ → 목적지별로 다른 외부 포트                     │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ Full Cone NAT:                                  │
│ Local IP | Local Port | Ext Port | Remote | Protocol │
│ 192.168.0.10 | 3000 | 8080 | ANY:ANY | TCP       │
│                                                 │
│ → 하나의 외부 포트로 모든 목적지 처리           │
└─────────────────────────────────────────────────┘

패킷 처리 과정:
┌─────────────────────────────────────────────────┐
│ 1. 최초 Outbound 연결:                          │
│   192.168.0.10:3000 → 15.15.15.15:80           │
│   NAT 변환: 3.3.3.3:8080 → 15.15.15.15:80      │
│                                                 │
│ 2. NAT 테이블 생성:                             │
│   내부: 192.168.0.10:3000 ↔ 외부: 8080         │
│   Remote: ANY (모든 외부 호스트 허용)           │
│                                                 │
│ 3. 다른 서버에서의 접근:                        │
│   9.9.9.9:80 → 3.3.3.3:8080                   │
│   자동 전달: → 192.168.0.10:3000               │
│                                                 │
│ 4. 양방향 통신 가능:                            │
│   어떤 외부 호스트든 8080포트로 접근 가능       │
└─────────────────────────────────────────────────┘

Full Cone의 특징:
┌─────────────────────────────────────────────────┐
│ 장점:                                           │
│ • P2P 연결 용이                                │
│ • NAT 홀 펀칭 불필요                           │
│ • 서버 운영 가능                                │
│ • 게임 호스팅 가능                              │
│                                                 │
│ 단점:                                           │
│ • 보안성 취약                                   │
│ • 외부 스캔 공격에 노출                         │
│ • 포트 충돌 가능성                              │
│ • DDoS 공격 취약                               │
└─────────────────────────────────────────────────┘
```

## 랑데부 서버와 P2P 연결

그러면 **이러한 방식이 게임을 원활하게 할 수 있냐 하면 게임에는 랑데부 서버라는 것이 존재한다. 이 랑데부 서버는 PC와 접속을 통해 해당 PC와 매핑되어 있는 포트 번호를 실제 직접 P2P 통신할 PC에게 알려주고 그 PC가 직접 3.3.3.3:8080으로 직접 통신하게 된다**.

```
랑데부 서버 (Rendezvous Server) 동작:

P2P 연결 설정 과정:
┌─────────────────────────────────────────────────┐
│ 1. 초기 등록 단계:                              │
│                                                 │
│ 플레이어A (192.168.0.10)                        │
│     │                                           │
│     └──→ 랑데부 서버 (중계 서버)                │
│                 │                               │
│     ┌───────────┘                               │
│     │                                           │
│ 플레이어B (10.0.0.20)                          │
│                                                 │
│ • 각 플레이어가 랑데부 서버에 접속              │
│ • 서버가 각자의 공인 IP:포트 정보 수집          │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 2. 주소 교환 단계:                              │
│                                                 │
│ 랑데부 서버 정보:                               │
│ • 플레이어A: 3.3.3.3:8080                      │
│ • 플레이어B: 4.4.4.4:9090                      │
│                                                 │
│ 서버가 각 플레이어에게 상대방 정보 전달:        │
│ • A에게: "B는 4.4.4.4:9090"                    │
│ • B에게: "A는 3.3.3.3:8080"                    │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│ 3. 직접 연결 시도:                              │
│                                                 │
│ 플레이어A ────────────→ 플레이어B                │
│ (3.3.3.3:8080)     (4.4.4.4:9090)             │
│                                                 │
│ Full Cone NAT에서:                              │
│ • A의 NAT: 8080포트가 이미 열려있음             │
│ • B의 연결 시도가 바로 A에게 도달               │
│ • 직접 P2P 연결 성공                           │
└─────────────────────────────────────────────────┘

실제 게임 예시:
┌─────────────────────────────────────────────────┐
│ 스타크래프트 배틀넷:                            │
│ 1. 배틀넷 서버에 로그인                         │
│ 2. 게임 로비에서 호스트/참가자 설정             │
│ 3. 호스트의 공인 IP:포트 정보 교환              │
│ 4. 참가자들이 호스트에게 직접 연결              │
│ 5. P2P 기반 게임 진행                          │
│                                                 │
│ Counter-Strike:                                │
│ 1. 마스터 서버에서 게임 리스트 조회             │
│ 2. 선택한 서버의 IP:포트 정보 획득              │
│ 3. 해당 서버에 직접 연결                        │
│ 4. 게임 참여                                    │
└─────────────────────────────────────────────────┘
```

## NAT 홀 펀칭 (Hole Punching)

```
NAT 홀 펀칭 기법:

기본 원리:
┌─────────────────────────────────────────────────┐
│ Symmetric NAT에서도 P2P 연결 가능하게 하는 기법 │
│                                                 │
│ 1. 동시 연결 시도 (Simultaneous Open):          │
│   • 양쪽에서 동시에 연결 시도                   │
│   • 타이밍이 맞으면 연결 성공                   │
│                                                 │
│ 2. 중계 서버 활용:                              │
│   • STUN (Session Traversal Utilities for NAT) │
│   • TURN (Traversal Using Relays around NAT)   │
│   • ICE (Interactive Connectivity Establishment)│
└─────────────────────────────────────────────────┘

STUN 서버 동작:
┌─────────────────────────────────────────────────┐
│ 1. NAT 타입 감지:                               │
│   • 클라이언트가 여러 STUN 서버에 요청          │
│   • 응답을 통해 NAT 유형 판별                   │
│   • Full Cone, Restricted Cone, Symmetric 구분 │
│                                                 │
│ 2. 공인 주소 발견:                              │
│   • 클라이언트의 공인 IP:포트 정보 제공         │
│   • NAT 매핑 정보 수집                         │
│                                                 │
│ 3. 연결 가능성 판단:                            │
│   • NAT 타입에 따른 P2P 가능성 평가             │
│   • 대안 방법 제시                              │
└─────────────────────────────────────────────────┘

TURN 서버 (중계):
┌─────────────────────────────────────────────────┐
│ 직접 P2P 연결이 불가능한 경우:                   │
│                                                 │
│ 클라이언트A ←→ TURN 서버 ←→ 클라이언트B          │
│                                                 │
│ • 서버가 트래픽을 중계                          │
│ • 대역폭과 지연시간 증가                        │
│ • 하지만 연결은 보장                            │
└─────────────────────────────────────────────────┘
```

## 보안성 트레이드오프

**다른 서버와 통신한 기록을 가지고 제3의 호스트가 직접 내부 호스트로 접속을 할 수 있다는 장점이 있다. 반면에 보안성이라는 관점에서 보면 좋지 않다**.

```
Full Cone NAT 보안 위험:

취약점:
┌─────────────────────────────────────────────────┐
│ 1. 무차별 접근 허용:                            │
│   • 한 번 포트가 열리면 모든 외부에서 접근 가능  │
│   • 공격자가 포트 스캔으로 열린 포트 발견 가능   │
│                                                 │
│ 2. 서비스 거부 공격 (DoS):                      │
│   • 열린 포트로 대량 트래픽 전송                │
│   • 내부 호스트 과부하 유발                     │
│                                                 │
│ 3. 정보 수집:                                   │
│   • 응답 패턴으로 내부 서비스 파악              │
│   • 포트 매핑 정보 수집                         │
└─────────────────────────────────────────────────┘

완화 방안:
┌─────────────────────────────────────────────────┐
│ 1. 애플리케이션 레벨 보안:                       │
│   • 강력한 인증 메커니즘                        │
│   • 암호화 통신                                 │
│   • 접근 제어 목록 (ACL)                       │
│                                                 │
│ 2. 타임아웃 관리:                               │
│   • 비활성 연결 자동 종료                       │
│   • 짧은 NAT 엔트리 유지 시간                   │
│                                                 │
│ 3. 하이브리드 접근:                             │
│   • 필요시에만 Full Cone 모드 활성화            │
│   • 게임 종료 후 Symmetric 모드로 복귀          │
└─────────────────────────────────────────────────┘

실제 구현 사례:
┌─────────────────────────────────────────────────┐
│ 게임용 공유기:                                  │
│ • UPnP (Universal Plug and Play) 지원          │
│ • 자동 포트 포워딩                              │
│ • 게임별 최적화 설정                            │
│                                                 │
│ 기업용 방화벽:                                  │
│ • 기본적으로 Symmetric NAT                     │
│ • VPN 연결 시에만 Full Cone 허용               │
│ • 정책 기반 NAT 타입 선택                      │
└─────────────────────────────────────────────────┘
```

이러한 **Full Cone NAT의 특성**을 이해하면 **네트워크 보안과 P2P 애플리케이션 요구사항 간의 균형점**을 찾을 수 있고, **상황에 맞는 NAT 설정**을 선택할 수 있습니다.