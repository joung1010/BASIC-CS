# IPSec(IP Security)

## IPSec의 기본 개념과 특징

**IPSec은 네트워크 계층에 보안 서비스를 제공하며 패킷 단위로 적용된다. 현재 사용 중인 IPv4, IPv6, GtoG(Gateway To Gateway-라우터), GtoE(Gateway To Endpoint-PC)를 모두 지원한다. IPSec은 GtoG(Gateway To Gateway) VPN 구현을 위해서 현재 가장 많이 사용되고 있는 방식이다**.

IPSec이 다른 VPN 기술과 구별되는 가장 중요한 특징은 **네트워크 계층(L3)에서 동작**한다는 점입니다. 이는 앞서 학습한 OSI 7계층 모델에서 IP가 동작하는 계층과 동일합니다. 따라서 **상위 계층의 애플리케이션이 무엇이든 상관없이 모든 IP 트래픽을 보호**할 수 있습니다.

```
IPSec 동작 계층:

OSI 7 Layer Model:
┌─────────────────┐
│ Application (7) │ ← HTTP, FTP 등 (IPSec과 무관)
├─────────────────┤
│ Presentation(6) │
├─────────────────┤
│ Session (5)     │
├─────────────────┤
│ Transport (4)   │ ← TCP, UDP
├─────────────────┤
│ Network (3)     │ ← IPSec 동작 계층 (IP)
├─────────────────┤
│ Data Link (2)   │
├─────────────────┤
│ Physical (1)    │
└─────────────────┘
```

**여기서 GtoG, GtoE에서, to 연결은 터널을 만든다는 것이다. 이것이 터널링이다. 이 터널링은 도로에서 산을 지날 때 터널을 지는 것처럼 그 밖에서 어떤 차를 감시하고 있는데 그 차가 터널 속으로 들어가면 순간 차가 안 보이고 찾을 수 없게 된다. 이처럼 터널링은 단순하게 보이지 않는다. 라고 이해하면 된다. 그래서 암호화해서 밖에서 봐도 알아볼 수 없음인데 이를 전문용어로 터널링이라 부르는 것이다**.

## IPSec이 제공하는 보안 서비스

그래서 **이 IPSec은 다음과 같은 서비스를 제공한다**:

**Access Control (접근 제어)**: 인증되지 않은 사용자나 시스템의 네트워크 접근을 차단합니다. IPSec은 사전에 설정된 보안 정책에 따라 특정 IP 주소나 네트워크에서만 접근을 허용합니다.

**Connectionless Integrity (비연결 무결성)**: 각 IP 패킷이 전송 중에 변조되지 않았음을 보장합니다. 해시 함수를 사용하여 패킷의 체크섬을 계산하고, 수신측에서 이를 검증합니다.

**Data Origin Authentication (데이터 출처 인증)**: 패킷이 정말로 주장하는 출발지에서 왔는지 확인합니다. 이는 IP 스푸핑 공격을 방지하는 핵심 기능입니다.

**Protection Against Replay (재전송 공격 방지)**: 공격자가 이전에 캡처한 패킷을 다시 전송하는 공격을 방지합니다. 시퀀스 번호를 사용하여 중복된 패킷을 탐지합니다.

**Confidentiality (기밀성)**: 강력한 암호화를 통해 패킷 내용을 보호합니다. 제3자가 패킷을 가로채더라도 내용을 해독할 수 없습니다.

**그래서 IPSec은 IP 수준(L3) 수준에서 보안을 제공한다. 따라서 응용 프로그램에 대한 의존성이 없고 IP 기반 통신을 모두 보호할 수 있다는 장점이 있다**.

## IPSec의 3가지 핵심 프로토콜

**그래서 IPSec을 말할 때 3개의 프로토콜이 등장한다**.

### ISAKMP (Internet Security Association Key Management Protocol)

**ISAKMP: Internet Security Association Key Management Protocol은 보안 협상 및 암호화 키를 관리하는 메커니즘을 제공한다**.

**여기서 말하는 키는 암호화 키를 말한다. 간단하게 Gateway끼리 암호화를 하는데 뭘로 암호화하고 키는 뭐를 쓰고 그걸 얼마 주기로 변경하고 이러한 협상을 말한다**.

ISAKMP는 IPSec의 "협상자" 역할을 담당합니다. 두 VPN 게이트웨이가 터널을 설정하기 전에 다음과 같은 사항들을 협상합니다:

**암호화 알고리즘 선택**: AES-128, AES-256, ChaCha20 중 어떤 것을 사용할지 결정합니다. 양쪽 게이트웨이가 모두 지원하는 가장 강력한 알고리즘을 선택합니다.

**해시 알고리즘 선택**: SHA-256, SHA-384, MD5 중 무결성 검증에 사용할 알고리즘을 선택합니다.

**키 교환 방식**: Diffie-Hellman 키 교환의 그룹을 선택합니다. 더 큰 그룹일수록 보안이 강화되지만 성능은 떨어집니다.

**키 갱신 주기**: 보안 강화를 위해 암호화 키를 주기적으로 변경하는데, 이 주기를 협상합니다.

```
ISAKMP 협상 과정:

Phase 1 (IKE 협상):
게이트웨이A → 게이트웨이B: "지원 가능한 암호화 방식 목록"
게이트웨이B → 게이트웨이A: "선택된 암호화 방식"
양방향: Diffie-Hellman 키 교환
결과: 관리용 보안 채널 구축

Phase 2 (IPSec 협상):
게이트웨이A ↔ 게이트웨이B: "실제 데이터 터널 설정"
결과: ESP/AH 터널 구축 완료
```

### IP AH (Authentication Header)

**IP AH(Authentication Header): AH는 데이터의 원본 인증 및 무결성 재전송 공격 방지 기능을 제공한다. 무결성은 결국 해시 알고리즘을 가지고 처리한다**.

AH는 **인증과 무결성**에 특화된 프로토콜입니다. 암호화는 제공하지 않으므로 데이터 내용은 평문으로 전송되지만, 누가 보냈는지와 변조 여부는 확실히 검증할 수 있습니다.

AH의 동작 방식을 구체적으로 살펴보면, 송신측에서 원본 IP 패킷에 대해 HMAC-SHA256 같은 해시 함수를 적용하여 인증 값을 계산합니다. 이 인증 값을 AH 헤더에 포함시켜 전송합니다. 수신측에서는 받은 패킷에 대해 동일한 해시 함수를 적용하고, 계산된 값이 AH 헤더의 값과 일치하는지 확인합니다.

### IP ESP (Encapsulating Security Payload)

**IP ESP(Encapsulation Security Payload): ESP는 데이터의 기밀성, 원본 인증 및 기밀성 및 재전송 공격 방지 기능을 제공한다. 원본에 대한 암호화 제공**.

ESP는 IPSec의 **핵심 프로토콜**로, AH의 모든 기능에 암호화까지 추가한 완전한 보안 솔루션입니다. 실제 업무용 VPN에서는 대부분 ESP를 사용합니다.

**그래서 IPSec이 터널이라는 어떤 비유적인 논리적인 체계를 결국 해시와 암호화 기술로 구현한다. 그래서 인증에 관해서는 AH 프로토콜을 암호화 관해서는 ESP 프로토콜을 사용하고 이 둘을 조합해서 한 번에 적용하기도 한다**.

## VPN 터널링의 패킷 변환 과정

IPSec의 터널링 과정을 단계별로 살펴보겠습니다:

### 원본 패킷 구조

```
Original Datagram
-----------------------
| IP Header  | PayLoad |
-----------------------
```

### ESP Transport 모드

```
Original Datagram protected by ESP-Transport mode
----------------------------------------------------------------------
| IP Header  | ESP Header | IP Payload    | ESP Trailer | ESP Auth |
----------------------------------------------------------------------
                           <    Encrypted         >
             <            Authenticated                >
```

Transport 모드에서는 **원본 IP 헤더는 그대로 두고 페이로드만 암호화**합니다. 이는 같은 네트워크 내에서 종단 간 보안이 필요할 때 사용됩니다.

### ESP Tunnel 모드

```
Original Datagram protected by ESP-tunnel
----------------------------------------------------------------------------------------
| New         |ESP Header | 
| IP Header   |           |  IP Header    | IP Payload    | ESP Trailer | ESP Auth |
---------------------------------------------------------------------------------------
                           <                    Encrypted         >
             <                     Authenticated                 >
```

**원본 패킷을 통으로 암호화한 다음에 새롭게 IP Header가 붙는다. 추가적으로 IPSec 헤더와 관련된 내용들이 들어가면서 누가 밖에서 봐도 암호화가 되어있어서 알 수 없게 된다. 하지만 IP 주소는 일정 수준에서 노출이 될 수밖에 없다**.

Tunnel 모드가 VPN에서 주로 사용되는 이유는 **완전한 패킷 보호**가 가능하기 때문입니다. 원본 패킷 전체가 암호화되므로 실제 출발지와 목적지 IP 주소도 숨겨집니다.

## 실제 VPN 시나리오에서의 동작

```
VPN GtoG

 부산지사                                        터널                             서울본사
PC(3.3.3.10)-                            ----------------                 - PC(5.5.5.50)
             |         2                |               |       1         |
PC(3.3.3.20)-|------ 라우터(3.3.3.1) -----|인터넷          |-----라우터5.5.5.1 |-PC(5.5.5.60)
             |                          |               |                 |
PC(3.3.3.30)-|                          |----------------                 -DB(5.5.5.100)
```

**그래서 보통 DB는 가장 뒷쪽에 배치해서 완전하게 private하게 기본정책이 바깥에서 접속이 안 되게 구성한다. 그래서 이 5.5.5.100번은 같은 네트워크 안에 있는 PC들만 접속이 가능하다**.

이는 전형적인 네트워크 보안 설계입니다. **Defense in Depth** 전략에 따라 가장 중요한 자산인 데이터베이스를 네트워크의 가장 안쪽에 배치하고, 여러 보안 계층을 통과해야만 접근할 수 있도록 구성합니다.

**그래서 부산 지사에 3.3.3.10에서 데이터베이스 서버에 접속을 해야 되는데 물리적으로 private 네트워크로 연결되어 있다면 문제가 없지만 이 환경을 VPN으로 구축했다**.

### 터널링 과정의 상세 분석

**그러면 이때 게이트웨이 1번과 2번이 있는데 이 게이트웨이가 기본적으로 SG(Secure Gateway)가 되는 것이다**.

두 게이트웨이 간의 터널 설정이 완료된 후 실제 데이터 전송 과정을 살펴보겠습니다:

### 1단계: 원본 패킷 생성

```
Original Datagram
----------------------------------
| IP Header  |  TCP   |   PayLoad |
| s:3.3.3.10 |        |           |
| d:5.5.5.100|        |           |
-----------------------------------
```

부산 지사의 PC(3.3.3.10)에서 서울 본사의 DB(5.5.5.100)에 접속하기 위한 패킷을 생성합니다. 이때 PC는 VPN의 존재를 전혀 모르고, 마치 직접 연결된 것처럼 패킷을 만듭니다.

### 2단계: 게이트웨이에서 터널링 처리

**이 패킷이 2번 게이트웨이에 도착해서 목적지 주소를 확인해 보니까 서울 본사에 있는 DB 서버로 트래픽이 가고 있다는 것을 인지한 후 이 패킷을 통째로 SG에서 암호화를 시켜버린다. 그래서 외부에서 봐도 해당 데이터가 무엇인지 식별할 수 없다. 하지만 1번 SG는 이를 풀어서 확인할 수 있다. 이때 새로운 IP 헤더가 붙는다**.

```
                   <              암호화                  >
---------------------------------------------------------
 Outer IP Header  |Inner IP Header  |  TCP   |   PayLoad |
 s:3.3.3.1        | s:3.3.3.10      |        |           |
 d:5.5.5.1        | d:5.5.5.100     |        |           |
----------------------------------------------------------
```

이 과정에서 중요한 점들을 살펴보겠습니다:

**라우팅 정책 확인**: 2번 게이트웨이는 목적지 주소 5.5.5.100이 VPN 터널을 통해 전송되어야 할 트래픽인지 라우팅 테이블을 확인합니다.

**ESP 헤더 추가**: 원본 패킷에 ESP 헤더를 추가하고 전체를 암호화합니다.

**새로운 IP 헤더**: 게이트웨이 간 통신을 위한 새로운 IP 헤더가 추가됩니다. 외부에서는 3.3.3.1과 5.5.5.1 간의 통신으로만 보입니다.

### 3단계: 인터넷 전송

**그래서 이렇게 생긴 패킷이 터널을 지나서 1번에 도착하는 것이다. 근데 왜 터널이냐 공개된 인터넷 네트워크에서 누가 본다 하더라도 암호화 때문에 내용을 알 수 없기 때문이다. 그래서 구체적인 목적지는 알 수 없지만 부산 지사가 서울 지사랑 통신을 하고 있구나 정도까지의 정보는 막을 수 없다**.

이는 VPN의 한계이기도 합니다. **Traffic Analysis** 공격을 통해 통신 패턴, 트래픽 량, 시간대 등의 메타데이터는 여전히 노출될 수 있습니다. 하지만 실제 데이터 내용은 완전히 보호됩니다.

### 4단계: 목적지에서 복호화

**이 1번 SG에서는 도착한 패킷의 outer header를 제거하고 암호화된 패킷을 복호화한 다음에 실제 목적지에 트래픽을 보내준다**.

```
 <       제거      > <              복호화                  >
---------------------------------------------------------
 Outer IP Header  |Inner IP Header  |  TCP   |   PayLoad |
 s:3.3.3.1        | s:3.3.3.10      |        |           |
 d:5.5.5.1        | d:5.5.5.100     |        |           |
----------------------------------------------------------
```

1번 게이트웨이에서의 처리 과정:

**ESP 검증**: 먼저 ESP 인증 값을 확인하여 패킷이 변조되지 않았는지 검증합니다.

**복호화**: 사전에 협상된 키를 사용하여 암호화된 내용을 복호화합니다.

**원본 패킷 복원**: outer IP 헤더와 ESP 헤더를 제거하여 원본 패킷을 복원합니다.

**내부 라우팅**: 복원된 패킷을 목적지 5.5.5.100으로 전달합니다.

## 구매대행 비유를 통한 이해

**그래서 이렇게 해도 이해가 안 되면 구매대행을 생각하면 이해하기 쉽다. 미국에 있는 물건을 사야 되는데 직접 배송이 어려우니 대행업체를 통해 구매하게 된다. 이때 대행업체는 실제 미국 주소를 가지고 있어서 미국에서 특정 물건 사서 그 물건을 한국에 보내준다. 그래서 미국 내 주소에서 대행업체 주소로 물건 받고 그 박스 그대로 한 번 더 감싸서 한국 송장을 붙여서 보낸다. 그래서 한국에서 받을 때 2번 박스를 뜯어야 원하는 물건을 받을 수 있다**.

이 비유는 IPSec 터널링의 본질을 매우 잘 설명합니다:

```
구매대행 vs IPSec 터널링:

구매대행:
원본 상품 → 미국 박스 포장 → 대행업체 → 한국 박스 포장 → 최종 수령

IPSec 터널링:
원본 패킷 → ESP 암호화 → 게이트웨이 → 새 IP 헤더 → 목적지 복호화
```

**미국 박스**는 원본 IP 패킷과 ESP 암호화에 해당하고, **한국 박스**는 새로운 IP 헤더에 해당합니다. 그리고 **대행업체**는 VPN 게이트웨이의 역할을 담당합니다.

이러한 IPSec 기술을 통해 기업들은 인터넷이라는 공개 네트워크를 사용하면서도 전용선과 같은 수준의 보안을 확보할 수 있게 되었고, 이는 현대 비즈니스 네트워킹의 핵심 인프라가 되었습니다.


# VPN과 재택근무

## 재택근무 환경의 네트워크 문제

```
 부산지사                                        터널                             서울본사
PC(3.3.3.10)-                            ----------------                 - PC(5.5.5.50)
             |         2                |               |       1         |
PC(3.3.3.20)-|------ 라우터(3.3.3.1) -----|인터넷          |-----라우터5.5.5.1 |-PC(5.5.5.60)
             |                          |               |                 |
PC(3.3.3.30)-|                          |----------------                 -DB(5.5.5.100)
                                             |
                                             |
                                            라우터
                                             |
                               VPN Client   PC 집 
                                           9.9.9.9
```

**3.3.3.10 PC 사용자가 재택근무를 한다고 가정해보자, 이 서울 본사에 있는 DB는 로컬에 있는 PC만 이 접속이 가능한데 부산지사에서는 VPN으로 어떻게 접속이 가능했는데 재택을 하게 되면서 다시 한 번 문제가 발생한다**.

이는 현대 기업이 직면한 매우 현실적인 문제입니다. **Site-to-Site VPN**으로 지사 간 연결은 해결했지만, 개별 직원의 재택근무나 출장 시 접근은 별도의 솔루션이 필요합니다.

**그러면 집에 있는 PC(9.9.9.9)에서 5.5.5.100으로 접속을 시도하면 1번 게이트웨이에서 접속을 차단시킨다. 그러면 어떻게 해야 할까? 바로 VPN에 참가하는 방법으로 GtoE를 하면 되는 것이다**.

여기서 발생하는 근본적인 문제는 **네트워크 신뢰 경계(Trust Boundary)**입니다. 서울 본사의 DB 서버는 5.5.5.0/24 네트워크 대역에서만 접근을 허용하도록 방화벽이 설정되어 있습니다. 집에서 사용하는 9.9.9.9 IP는 이 신뢰 구역 밖에 있으므로 접근이 차단됩니다.

```
네트워크 신뢰 경계:

신뢰 구역 (Trust Zone):
- 3.3.3.0/24 (부산 지사)
- 5.5.5.0/24 (서울 본사)
↓ VPN 터널로 연결

비신뢰 구역 (Untrust Zone):
- 9.9.9.9 (재택근무 PC)
- 기타 모든 인터넷 IP
```

## GtoE VPN 솔루션

```
집에서 부산지사 VPN 연결

                    VPN 터널 (암호화)
VPN Client PC ═══════════════════════════════ 부산지사 SG
   9.9.9.9     ←  인터넷을 통한 보안 터널  →    3.3.3.1
                                                  |
                                             부산지사 LAN
                                                  |
                                           PC(3.3.3.10)
                                           PC(3.3.3.20)
                                           PC(3.3.3.30)
```

**집에 있는 PC에 VPN 프로그램을 설치한다. 그러면 어떤 일이 발생하느냐 이 9.9.9.9 PC가 3.3.3.1로 접속하게 되면 이 3.3.3.1 SG가 VPN Client한테 새로운 IP 주소를 주게 된다. 예를 들어 3.3.3.50번의 IP를 VPN Client에게 주게 된다. 그러면 이 집에 있는 PC는 IP 주소가 9.9.9.9와 3.3.3.50 2개 IP 주소를 가지게 된다. 3.3.3.50번은 부산지사에서 사용하는 대역이다**.

이 과정에서 일어나는 일들을 구체적으로 살펴보겠습니다:

### VPN 클라이언트 연결 과정

**1단계: 인증 및 터널 설정**
VPN 클라이언트가 3.3.3.1 게이트웨이에 연결을 시도하면, 먼저 사용자 인증이 진행됩니다. 이는 ID/PW, 인증서, 또는 다중 인증(MFA) 방식으로 이루어집니다.

**2단계: 가상 네트워크 인터페이스 생성**
인증이 완료되면 VPN 클라이언트 소프트웨어가 운영체제에 **가상 네트워크 어댑터(Virtual Network Adapter)**를 생성합니다. 이는 물리적 네트워크 카드처럼 동작하지만 실제로는 소프트웨어로 구현됩니다.

**3단계: IP 주소 할당**
부산 게이트웨이(3.3.3.1)가 자신의 IP 풀에서 사용 가능한 IP를 할당합니다. 예를 들어 3.3.3.50~3.3.3.99 범위를 VPN 클라이언트용으로 예약해두고, 연결 시마다 순차적으로 할당합니다.

```
PC의 네트워크 인터페이스 상태:

연결 전:
eth0: 9.9.9.9/24 (물리적 인터페이스)

연결 후:
eth0: 9.9.9.9/24 (물리적 인터페이스)
tun0: 3.3.3.50/24 (가상 인터페이스)
```

### 라우팅 테이블 변경

VPN 연결이 완료되면 PC의 라우팅 테이블이 자동으로 변경됩니다:

```
라우팅 테이블 변경:

연결 전:
default via 9.9.9.1 dev eth0
9.9.9.0/24 dev eth0

연결 후:
default via 9.9.9.1 dev eth0
9.9.9.0/24 dev eth0
3.3.3.0/24 via 3.3.3.1 dev tun0  ← 추가
5.5.5.0/24 via 3.3.3.1 dev tun0  ← 추가
```

이제 **5.5.5.100에 대한 트래픽은 tun0 인터페이스(VPN 터널)를 통해 전송**됩니다.

## 이중 터널링 과정

**이제는 집에서 패킷이 밑에와 같이 나가게 된다**.

```
---------------------------------
| IP Header | TCP | PayLoad |
| s:3.3.3.50 | | |
| d:5.5.5.100| | |
-----------------------------------
```

이 패킷 생성 과정을 자세히 살펴보겠습니다:

**애플리케이션 레벨**: 사용자가 데이터베이스 클라이언트 프로그램으로 5.5.5.100에 접속을 시도합니다.

**OS 라우팅**: 운영체제가 라우팅 테이블을 조회해서 5.5.5.100으로 가는 패킷은 tun0 인터페이스를 사용해야 한다고 결정합니다.

**가상 인터페이스**: tun0 인터페이스에서 출발지 IP를 3.3.3.50으로 설정하여 패킷을 생성합니다.

### 첫 번째 암호화 (Client-to-Gateway)

**그리고 이 PC와 3.3.3.1 SG와 터널링 되었다고 가정하면 위에 있는 패킷이 암호화가 될 것이다. 누가 암호화를 하느냐? 바로 VPN Client가 해당 패킷을 암호화시켜서 새로운 헤더를 붙이는데 이때 출발지가 9.9.9.9가 된다**.

```
                   <              암호화                  >
---------------------------------------------------------
 Outer IP Header  |Inner IP Header  |  TCP   |   PayLoad |
 s:9.9.9.9        | s:3.3.3.50      |        |           |
 d:3.3.3.1        | d:5.5.5.100     |        |           |
----------------------------------------------------------
```

VPN 클라이언트 소프트웨어의 역할을 구체적으로 분석하면:

**패킷 가로채기**: tun0 인터페이스로 전송되는 모든 패킷을 VPN 클라이언트가 가로챕니다.

**ESP 캡슐화**: 원본 패킷에 ESP 헤더를 추가하고 사전에 협상된 키로 암호화합니다.

**새로운 IP 헤더**: 물리적 인터넷 연결을 위한 새로운 IP 헤더를 추가합니다. 출발지는 집의 실제 IP(9.9.9.9), 목적지는 부산 게이트웨이(3.3.3.1)입니다.

### 게이트웨이에서의 처리

**위와 같이 생긴 패킷이 부산 게이트웨이에 도착하고 outer 헤더를 날리고 패킷을 복호화한 다음에 목적지가 5.5.5.100인 걸 확인하고 다시 1번 게이트웨이로 트래픽을 전달하는데 이때 뜯은 IP 헤더에 새로운 헤더를 붙여서 다시 전달한다**.

부산 게이트웨이(3.3.3.1)에서 일어나는 복잡한 처리 과정:

**1단계: VPN 터널 종료**

- outer IP 헤더 제거 (9.9.9.9 → 3.3.3.1)
- ESP 헤더 검증 및 복호화
- 원본 패킷 복원 (3.3.3.50 → 5.5.5.100)

**2단계: 라우팅 결정**
게이트웨이는 복원된 패킷의 목적지 5.5.5.100을 확인하고 라우팅 테이블을 조회합니다. 이 주소는 서울 본사 네트워크이므로 Site-to-Site VPN 터널을 통해 전송해야 합니다.

**3단계: 재암호화 (Gateway-to-Gateway)**

```
                    <             재암호화                  >
---------------------------------------------------------
 Outer IP Header  |Inner IP Header  |  TCP   |   PayLoad |
 s:3.3.3.1        | s:3.3.3.50      |        |           |
 d:5.5.5.1        | d:5.5.5.100     |        |           |
----------------------------------------------------------
```

여기서 흥미로운 점은 **동일한 패킷이 두 번 암호화**된다는 것입니다:

- 첫 번째: 재택근무 PC에서 부산 게이트웨이로 (GtoE VPN)
- 두 번째: 부산 게이트웨이에서 서울 게이트웨이로 (GtoG VPN)

### 서울 게이트웨이에서의 최종 처리

**그렇게 1번 게이트웨이가 받아서 아웃터 헤더를 제거하고 복호화한 다음에 원래 목적지로 트래픽을 전달하고 응답을 3.3.3.50으로 하게 되는 것이다**.

서울 게이트웨이(5.5.5.1)에서의 처리:

**터널 종료**: Site-to-Site VPN 터널을 종료하고 원본 패킷을 복원합니다.

**내부 라우팅**: 목적지 5.5.5.100이 같은 네트워크에 있음을 확인하고 직접 전달합니다.

**응답 경로**: DB 서버의 응답은 출발지 IP(3.3.3.50)를 보고 역경로로 전송됩니다.

```
전체 통신 흐름 요약:

재택 PC → 부산 GW → 서울 GW → DB 서버
(GtoE VPN)  (GtoG VPN)         (LAN)

응답 경로:
DB 서버 → 서울 GW → 부산 GW → 재택 PC
```

## 성능 및 보안 고려사항

이런 **이중 터널링 구조**는 강력한 보안을 제공하지만 몇 가지 고려사항이 있습니다:

**성능 오버헤드**: 두 번의 암호화/복호화로 인해 CPU 사용량이 증가하고 지연시간이 늘어납니다.

**복잡한 라우팅**: 네트워크 관리자는 두 개의 VPN 터널을 모두 고려한 라우팅 정책을 수립해야 합니다.

**장애 지점 증가**: 재택근무 PC, 부산 게이트웨이, 서울 게이트웨이 중 어느 하나라도 문제가 생기면 전체 연결이 끊어집니다.

하지만 이런 구조를 통해 **기업은 재택근무 환경에서도 본사와 동일한 수준의 보안과 접근성을 제공**할 수 있게 되었고, 이는 현대 하이브리드 워크 환경의 핵심 인프라가 되었습니다.

# VPN 악용

## VPN의 지리적 우회 기능

```
 부산지사                                        터널                             서울본사
PC(3.3.3.10)-                            ----------------                 - PC(5.5.5.50)
             |         2                |               |       1         |
PC(3.3.3.20)-|------ 라우터(3.3.3.1) -----|인터넷          |-----라우터5.5.5.1 |-PC(5.5.5.60)
             |                          |               |                 |
PC(3.3.3.30)-|                          |----------------                 -DB(5.5.5.100)
                                             |
                                             |
                                            라우터
                                             |
                               VPN Client   PC 집 
                                           9.9.9.9
                                           3.3.3.40
```

```
                    VPN 터널 (암호화)
VPN Client PC ═══════════════════════════════ 부산지사 SG
   9.9.9.9     ←  인터넷을 통한 보안 터널  →    3.3.3.1
   3.3.3.40                                       |
                                             부산지사 LAN
                                                  |
                                           PC(3.3.3.10)
                                           PC(3.3.3.20)
                                           PC(3.3.3.30)
```

**이 VPN 네트워크에 확장, 연계가 목적인데 이점을 반대로 악용하는 사례가 있다. 예를 들어 9.9.9.9의 PC 주인이 출장 때문에 해외에 가게 되었다. 이때 VPN을 통해 서울 본사에 접속해서 업무를 보고 게임을 하려고 VPN을 끄고 게임에 접속하였더니 너는 지금 현재 한국 서버가 아니니 외국 서버로 접속해 라고 해서 한국 서버에 접속이 불가능하게 되었다. 그래서 다시 VPN을 키고 한국 서버에 접속했을 때 실제 물리적으로 한국에 있지 않더라도 마치 한국에 있는 것처럼 해서 한국 서버에 접근할 수 있는 것이다**.

이는 VPN의 **지리적 위치 우회 기능**을 보여주는 대표적인 사례입니다. 많은 온라인 서비스들이 사용자의 IP 주소를 기반으로 지리적 제한을 적용하는데, VPN은 이러한 제한을 우회할 수 있게 해줍니다.

```
지리적 제한 우회 과정:

실제 위치: 미국 (IP: 1.2.3.4)
    ↓ VPN 연결
가상 위치: 한국 (IP: 3.3.3.40)
    ↓ 게임 서버 접속
게임 서버 인식: "한국에서 접속한 사용자"
```

이런 방식으로 다음과 같은 제한들을 우회할 수 있습니다:

**지역 제한 콘텐츠**: Netflix, YouTube, BBC iPlayer 등의 국가별 콘텐츠 제한을 우회할 수 있습니다.

**게임 서버 제한**: 특정 국가에서만 서비스하는 온라인 게임에 접속할 수 있습니다.

**웹사이트 차단**: 특정 국가에서 차단된 웹사이트에 접속할 수 있습니다.

**가격 차별화 우회**: 국가별로 다른 가격을 책정하는 서비스에서 더 저렴한 가격으로 구매할 수 있습니다.

## IP 주소 세탁의 개념

**이러한 걸 IP 주소 세탁이라 하는데 진짜 주소를 감추고 접근하는 것이다**.

- *IP 주소 세탁(IP Address Laundering)**은 자신의 실제 IP 주소를 숨기고 다른 IP 주소로 위장하여 인터넷 활동을 하는 것을 의미합니다. 이는 마치 돈세탁(Money Laundering)에서 돈의 출처를 숨기는 것과 유사한 개념입니다.

IP 주소 세탁의 주요 방법들:

**VPN 서비스**: 상업적 VPN 제공업체의 서버를 경유하여 자신의 IP를 숨깁니다.

**프록시 서버**: HTTP/SOCKS 프록시를 통해 웹 트래픽을 우회시킵니다.

**Tor 네트워크**: 여러 중계 서버를 거쳐 IP를 다중으로 숨깁니다.

**해킹된 시스템**: 타인의 컴퓨터나 서버를 해킹하여 중계지로 사용합니다.

```
IP 주소 세탁 체인:

실제 공격자 → VPN 서버 → 해킹된 PC → 프록시 → 목표 시스템
  (숨겨짐)    (1차 우회)   (2차 우회)   (3차 우회)    (추적 불가)
```

## PPTP VPN의 보안 위험성

**PPTP VPN(Point to Point Tunneling Protocol): MS사가 개발한 것으로 IP 캡슐화 터널링을 지원한다. 문제는 PPTP VPN을 가지고 IP를 설정해서 무언가를 할 수 있느냐 우리가 흔히 사용하는 ipTIME에서 이 기능을 지원하는데 만약에 공유기가 해킹당하고 이 PPTP VPN을 설정해서 이 공유기로 해킹을 시도하게 되면 상대쪽에서 봤을 때는 이 공유기가 할당받은 global IP가 있는데 이 주소로 추적해서 나를 고발하게 되는 것이다**.

PPTP의 보안 문제점들을 구체적으로 살펴보겠습니다:

**약한 암호화**: PPTP는 MS-CHAP v1/v2 인증과 MPPE 암호화를 사용하는데, 이는 현재 기준으로 매우 취약합니다. 무차별 대입 공격으로 몇 시간 내에 비밀번호를 해독할 수 있습니다.

**GRE 프로토콜 의존**: PPTP는 GRE(Generic Routing Encapsulation) 프로토콜을 사용하는데, 이는 상태 추적이 어려워 방화벽 설정이 복잡하고 NAT 환경에서 문제가 발생할 수 있습니다.

**키 재사용 문제**: PPTP는 동일한 암호화 키를 오랫동안 사용하여 패턴 분석 공격에 취약합니다.

```
PPTP 해킹 시나리오:

1. 공격자가 취약한 ipTIME 공유기 해킹
   ↓
2. PPTP VPN 서버 기능 활성화
   ↓ 
3. 공격자가 해킹된 공유기로 VPN 연결
   ↓
4. 공유기의 공인 IP로 사이버 범죄 수행
   ↓
5. 피해자 신고 → 공유기 소유자가 용의자로 지목
```

이런 상황에서 실제 공유기 소유자는 억울하게 범죄 혐의를 받을 수 있습니다. **디지털 포렌식 조사**를 통해 진실을 밝혀야 하지만, 이는 시간과 비용이 많이 드는 과정입니다.

## 다중 VPN 체인의 역추적 어려움

**그래서 대표적인 악용 사례는 IP 주소를 세탁하거나 우회해서 자기 자신을 감추기 때문에 해커들을 추적해도 못 잡는 가장 큰 이유가 VPN을 타고 또 다른 VPN을 타고 이렇게 경유하다 보니까 역추적에 어려움이 있다**.

- *다중 VPN 체인(VPN Chain)**은 여러 개의 VPN 서비스를 연쇄적으로 사용하여 추적을 더욱 어렵게 만드는 기법입니다.

```
다중 VPN 체인 구조:

공격자 PC → VPN A (미국) → VPN B (독일) → VPN C (일본) → 목표 시스템
     ↑           ↑              ↑              ↑            ↑
  실제 위치   1차 우회       2차 우회       3차 우회      최종 공격
```

이런 구조에서 역추적이 어려운 이유들:

**관할권 문제**: 각 VPN 서버가 다른 국가에 있으면 국제 공조 수사가 필요하며, 이는 매우 복잡하고 시간이 오래 걸립니다.

**로그 정책**: 많은 VPN 업체들이 "No-Log Policy"를 표방하며 사용자 접속 기록을 보관하지 않습니다.

**법적 절차**: 각 국가별로 다른 법적 절차를 거쳐야 하며, 일부 국가는 수사 협조를 거부할 수 있습니다.

**시간 지연**: 여러 단계를 거쳐 추적하는 동안 로그가 삭제되거나 증거가 소멸될 수 있습니다.

## 현대적 익명화 기술

VPN 외에도 다양한 익명화 기술들이 존재합니다:

**Tor 네트워크**: 3개의 중계 노드를 거쳐 트래픽을 전송하며, 각 노드는 이전/다음 노드의 정보만 알 수 있습니다.

**I2P (Invisible Internet Project)**: P2P 기반의 익명 네트워크로, 각 사용자가 네트워크의 라우터 역할을 담당합니다.

**Freenet**: 분산형 정보 저장 시스템으로, 검열과 감시에 저항하는 네트워크를 구축합니다.

```
Tor vs VPN 비교:

Tor:
- 3-hop 암호화 (3중 보안)
- 무료 사용 가능
- 느린 속도
- 브라우저 트래픽에 최적화

VPN:
- 단일 hop 암호화
- 유료 서비스 대부분
- 빠른 속도  
- 모든 인터넷 트래픽 지원
```

## 법 집행 기관의 대응 방법

완벽한 익명성은 존재하지 않으며, 법 집행 기관들도 다양한 방법으로 추적을 시도합니다:

**트래픽 분석**: 암호화된 내용은 볼 수 없지만, 통신 패턴, 시간대, 트래픽 량 등을 분석하여 사용자를 특정합니다.

**취약점 공격**: VPN이나 Tor 클라이언트의 보안 취약점을 이용하여 실제 IP를 노출시킵니다.

**측채널 공격**: DNS 누수, WebRTC 누수, 시간대 정보 등을 통해 실제 위치를 파악합니다.

**국제 공조**: 국제 수사 공조를 통해 여러 국가의 VPN 서버 로그를 종합 분석합니다.

**허니팟 운영**: 법 집행 기관이 직접 VPN 서비스나 Tor 출구 노드를 운영하여 사용자 정보를 수집합니다.

```
성공적인 추적 사례:

실크로드 사건 (2013):
Tor → 서버 설정 실수로 실제 IP 노출 → 운영자 체포

AlphaBay 사건 (2017):
다중 VPN → 이메일 계정 연결점 발견 → 운영자 검거

Colonial Pipeline 랜섬웨어 (2021):
VPN 체인 → 비트코인 추적 → 일부 몸값 회수
```

이처럼 VPN은 합법적인 목적으로는 매우 유용한 도구이지만, 악용될 경우 사이버 범죄의 온상이 될 수 있어 **기술적 발전과 함께 윤리적 사용**이 중요한 이슈가 되고 있습니다.